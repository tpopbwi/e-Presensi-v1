<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UPT PSDA - Pro Attendance System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseInit = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, getDoc };
    </script>

    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-highlight: rgba(255, 255, 255, 0.7);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #cbd5e1;
            margin: 0; padding: 0;
            height: 100dvh;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        .bg-decoration {
            position: absolute; width: 500px; height: 500px; border-radius: 50%;
            filter: blur(120px); z-index: -1; animation: move 25s infinite alternate;
        }
        @keyframes move { from { transform: translate(-50%, -50%); } to { transform: translate(50%, 50%); } }

        .app-container {
            width: 100%; height: 100dvh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(40px) saturate(160%);
            -webkit-backdrop-filter: blur(40px) saturate(160%);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            border-left: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-border);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (min-width: 1024px) {
            .app-container { width: 420px; height: 880px; max-height: 95vh; border-radius: 40px; border: 2px solid var(--glass-border); box-shadow: 0 50px 100px rgba(0,0,0,0.25); }
        }

        .pill-glass-3d {
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); border-radius: 22px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.15), inset 0 1px 1px var(--glass-highlight);
            transition: all 0.1s ease; position: relative; overflow: hidden;
        }
        .pill-glass-3d:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 3px 0 rgba(0,0,0,0.15); }
        .pill-glass-3d:disabled { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; }

        .input-glass {
            background: rgba(255, 255, 255, 0.15); border: 1px solid var(--glass-border);
            border-radius: 15px; backdrop-filter: blur(10px); box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
            width: 100%; padding: 14px; font-weight: 600; color: #1e293b;
        }

        .screen {
            position: absolute; inset: 0; padding: 20px;
            display: flex; flex-direction: column;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease;
            will-change: transform, opacity; z-index: 1;
        }
        .screen-hidden { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .screen-prev { transform: translateX(-30%) scale(0.9); opacity: 0; pointer-events: none; }
        .screen-active { transform: translateX(0); opacity: 1; z-index: 10; }

        .locked-section { opacity: 0.3; pointer-events: none; filter: blur(4px); transition: all 0.5s ease; }
        .unlocked-section { opacity: 1; pointer-events: auto; filter: none; }

        #camera-overlay, #qr-scanner-overlay { position: absolute; inset: 0; background: black; z-index: 1000; display: none; flex-direction: column; }
        
        .toast-pro {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-150px);
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 15px 25px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); z-index: 10000;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: max-content; max-width: 90vw; border: 1px solid white;
        }
        .toast-pro.show { transform: translateX(-50%) translateY(0); }

        .photo-portrait-shadow {
            box-shadow: 0 35px 80px -15px rgba(0, 0, 0, 0.8), 0 25px 40px -20px rgba(0, 0, 0, 1);
            border: 5px solid rgba(255,255,255,0.25);
        }

        #modal-confirm, #modal-qr-success {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px);
            z-index: 9500; display: none; align-items: center; justify-content: center; padding: 20px;
        }

        .active-hadir { background: #10b981 !important; color: white !important; box-shadow: 0 6px 0 #065f46 !important; }
        .active-pulang { background: #f59e0b !important; color: white !important; box-shadow: 0 6px 0 #92400e !important; }
        .active-special { background: #3b82f6 !important; color: white !important; box-shadow: 0 6px 0 #1e40af !important; }
        .active-error { background: #334155 !important; color: white !important; box-shadow: 0 6px 0 #0f172a !important; }

        .step-check { color: #10b981; font-weight: bold; font-size: 14px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        #qr-reader { width: 100% !important; border: none !important; }
        #qr-reader video { border-radius: 20px; }
    </style>
</head>
<body>

    <div class="bg-decoration bg-blue-500" style="top: 0%; left: 0%;"></div>
    <div class="bg-decoration bg-emerald-400" style="bottom: 0%; right: 0%;"></div>

    <!-- TOAST ELEMENT -->
    <div id="toast-element" class="toast-pro">
        <div id="toast-icon-box" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">!</div>
        <div class="flex flex-col">
            <p id="toast-title" class="text-[10px] font-black uppercase text-slate-400 tracking-widest leading-none mb-1">Pemberitahuan</p>
            <p id="toast-text" class="text-xs font-bold text-slate-800 tracking-tight"></p>
        </div>
    </div>

    <!-- MODAL CONFIRMATION -->
    <div id="modal-confirm">
        <div class="bg-white rounded-[35px] p-8 w-full max-sm shadow-2xl space-y-6">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2"/></svg>
            </div>
            <div class="text-center space-y-2">
                <h3 class="font-black text-xl text-slate-800 uppercase tracking-tighter">Konfirmasi Presensi</h3>
                <p id="modal-msg" class="text-sm text-slate-500 font-medium"></p>
            </div>
            <div class="flex gap-3">
                <button onclick="window.closeModal()" class="flex-1 py-4 font-bold text-slate-400 uppercase text-xs">Batal</button>
                <button id="confirm-submit-btn" class="flex-1 pill-glass-3d bg-slate-900 text-white font-black uppercase text-xs !shadow-[0_4px_0_#000]">Kirim</button>
            </div>
        </div>
    </div>

    <!-- MODAL QR SUCCESS -->
    <div id="modal-qr-success">
        <div class="bg-white rounded-[40px] p-8 w-full max-w-sm shadow-2xl text-center space-y-6">
            <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto">
                <svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="4"/></svg>
            </div>
            <h3 class="font-black text-xl text-slate-800 uppercase tracking-tighter leading-none">Berhasil!</h3>
            <p class="text-xs text-slate-400 font-bold uppercase">QR Code Akses Login Anda</p>
            <div class="bg-slate-50 p-4 rounded-3xl border-2 border-dashed border-emerald-200">
                <img id="qr-display-img" src="" class="mx-auto w-48 h-48 rounded-xl" alt="QR Login">
            </div>
            <p class="text-[10px] text-slate-400 font-bold italic">Simpan QR ini untuk login cepat</p>
            <button onclick="location.reload()" class="w-full pill-glass-3d bg-slate-900 text-white py-4 font-black uppercase text-sm !shadow-[0_5px_0_#000]">Selesai</button>
        </div>
    </div>

    <!-- GLOBAL LOADER -->
    <div id="global-loader" class="loading-overlay fixed inset-0 bg-slate-900/60 backdrop-blur-md hidden flex-col items-center justify-center z-[9000] text-white">
        <div class="spinner mb-4"></div>
        <p id="loader-text" class="font-bold tracking-widest text-[10px] uppercase">Sinkronisasi Server...</p>
    </div>

    <div class="app-container">
        
        <!-- CAMERA OVERLAY -->
        <div id="camera-overlay">
            <video id="video-preview" class="w-full h-full object-cover" autoplay playsinline></video>
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-72 h-96 border-2 border-emerald-500 rounded-3xl shadow-[0_0_0_1000px_rgba(0,0,0,0.7)] pointer-events-none"></div>
            <div class="absolute bottom-10 left-0 right-0 flex justify-around items-center px-10">
                <button onclick="window.closeCamera()" class="p-4 bg-white/20 rounded-full text-white backdrop-blur-md"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2"/></svg></button>
                <button onclick="window.takePicture()" class="w-20 h-20 bg-white rounded-full border-8 border-white/30 shadow-2xl active:scale-90 transition"></button>
                <div class="w-14"></div>
            </div>
        </div>

        <!-- QR SCANNER OVERLAY -->
        <div id="qr-scanner-overlay">
            <div class="flex-1 flex flex-col p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-white font-black uppercase tracking-widest text-sm">Scan QR Akses</h2>
                    <button onclick="window.stopQRScanner()" class="p-2 bg-white/10 rounded-full text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2"/></svg></button>
                </div>
                <div class="bg-white/5 rounded-[40px] overflow-hidden p-4 border border-white/10 flex-1 flex items-center">
                    <div id="qr-reader" class="w-full"></div>
                </div>
                <div class="py-10 text-center">
                    <p class="text-white/40 text-[10px] uppercase font-bold tracking-widest">Arahkan kamera ke QR Code pegawai Anda</p>
                </div>
            </div>
        </div>

        <!-- SCREEN: LOGIN -->
        <div id="login-screen" class="screen screen-active justify-center space-y-8 px-6">
            <div class="flex flex-col items-center">
                <div class="w-24 h-24 bg-slate-900 rounded-[32px] flex items-center justify-center mb-4 shadow-2xl rotate-3 transition hover:rotate-0 duration-500">
                    <svg viewBox="0 0 24 24" class="w-14 h-14 text-white fill-current"><path d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z" /></svg>
                </div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tighter text-center uppercase leading-none">UPT PSDA<br><span class="text-emerald-600">BONDOYUDO</span></h1>
            </div>
            <div class="space-y-4">
                <input id="login-username" type="text" placeholder="Nama / Email / HP" class="input-glass">
                <input id="login-password" type="password" placeholder="Password" class="input-glass">
                <div class="flex items-center gap-3 px-2 py-1">
                    <input type="checkbox" id="save-session" class="w-5 h-5 rounded border-white/30 bg-white/20 text-emerald-600 focus:ring-emerald-500 cursor-pointer">
                    <label for="save-session" class="text-[10px] font-black text-slate-600 uppercase tracking-widest cursor-pointer">Ingat Saya</label>
                </div>
                <button id="login-btn-action" onclick="window.handleLogin()" class="w-full pill-glass-3d py-4 bg-slate-900 text-white font-black text-lg shadow-[0_6px_0_#000]">MASUK</button>
            </div>
            <div class="flex items-center gap-4 py-2 opacity-50"><div class="flex-1 h-[1px] bg-slate-400"></div><span class="text-[10px] font-bold uppercase">Atau</span><div class="flex-1 h-[1px] bg-slate-400"></div></div>
            <button onclick="window.startQRScanner()" class="w-full pill-glass-3d py-4 flex items-center justify-center gap-3 font-extrabold text-slate-700 bg-white/40">
                <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h3m-3-3H8" stroke-width="2.5"/></svg>
                SCAN QR LOGIN
            </button>
            <div class="flex justify-between items-end pb-4 pt-4 px-2">
                <button onclick="window.navigateTo('forgot-screen')" class="text-left group focus:outline-none"><p class="text-slate-800 font-bold text-xs leading-none">Password</p><p class="text-[10px] text-slate-500 uppercase group-hover:underline">Lupa Sandi?</p></button>
                <button onclick="window.navigateTo('register-screen')" class="text-right group focus:outline-none"><p class="text-emerald-700 font-bold text-xs leading-none">Register</p><p class="text-[10px] text-slate-500 uppercase underline">Daftar Akun</p></button>
            </div>
        </div>

        <!-- SCREEN: REGISTER -->
        <div id="register-screen" class="screen screen-hidden overflow-y-auto scrollbar-hide">
            <div class="flex items-center gap-4 mb-8" onclick="window.navigateTo('login-screen')">
                <div class="p-2 bg-slate-900/10 rounded-xl"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg></div>
                <h2 class="text-xl font-black text-slate-800 tracking-tight">Pendaftaran Pegawai</h2>
            </div>
            <div class="space-y-6 pb-12">
                <div class="flex flex-col items-center space-y-4">
                    <div class="w-32 h-48 rounded-[25px] relative photo-portrait-shadow overflow-hidden bg-slate-300">
                        <div id="preview-profile" class="absolute inset-0 hidden"><img class="w-full h-full object-cover"></div>
                        <div id="placeholder-reg-photo" class="absolute inset-0 flex items-center justify-center">
                            <svg id="placeholder-icon" class="w-12 h-12 text-slate-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="window.openCamera('profile')" class="pill-glass-3d p-3 bg-white/50 text-slate-700 flex items-center gap-2 text-xs font-bold"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Foto</button>
                        <button onclick="document.getElementById('file-upload-profile').click()" class="pill-glass-3d p-3 bg-white/50 text-slate-700 flex items-center gap-2 text-xs font-bold"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>Upload</button>
                        <input type="file" id="file-upload-profile" class="hidden" accept="image/*" onchange="window.handleFileUpload(event)">
                    </div>
                </div>
                <div class="space-y-4">
                    <input id="reg-id" type="text" placeholder="ID Pegawai (P001...)" class="input-glass">
                    <input id="reg-nama" type="text" placeholder="Nama Lengkap" class="input-glass">
                    <select id="reg-jabatan" class="input-glass" onchange="window.toggleManual(this, 'manual-jabatan')">
                        <option value="" disabled selected>Pilih Jabatan</option>
                        <option value="PPA">PPA</option><option value="Pekarya">Pekarya</option><option value="Staf Pengamat">Staf Pengamat</option><option value="manual">Isi manual...</option>
                    </select>
                    <input id="manual-jabatan" type="text" placeholder="Ketik Jabatan" class="input-glass hidden border-emerald-400">
                    <select id="reg-wilayah" class="input-glass" onchange="window.toggleManual(this, 'manual-wilayah')">
                        <option value="" disabled selected>Pilih Wilayah</option>
                        <option value="Bangorejo">Bangorejo</option><option value="Cluring">Cluring</option><option value="Pesanggaran">Pesanggaran</option><option value="Porolinggo">Porolinggo</option><option value="manual">Isi manual...</option>
                    </select>
                    <input id="manual-wilayah" type="text" placeholder="Ketik Wilayah" class="input-glass hidden border-emerald-400">
                    <input id="reg-email" type="email" placeholder="Email Aktif" class="input-glass">
                    <input id="reg-hp" type="tel" placeholder="Chat ID Telegram (Bot User Info)" class="input-glass">
                    <input id="reg-lokasi" type="text" placeholder="Lokasi Penempatan" class="input-glass">
                    <input id="reg-password" type="password" placeholder="Password Baru" class="input-glass">
                </div>
                <button onclick="window.handleRegister()" class="w-full pill-glass-3d py-5 bg-emerald-600 text-white font-black text-lg shadow-[0_6px_0_#064e3b]">DAFTAR SEKARANG</button>
            </div>
        </div>

        <!-- SCREEN: FORGOT PASSWORD -->
        <div id="forgot-screen" class="screen screen-hidden">
            <div class="flex items-center gap-4 mb-10" onclick="window.navigateTo('login-screen')">
                <div class="p-2 bg-slate-900/10 rounded-xl"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg></div>
                <h2 class="text-xl font-black text-slate-800">Reset Password</h2>
            </div>
            <div class="flex-1 flex flex-col justify-center space-y-6">
                <div class="text-center space-y-2">
                    <div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                        <svg class="w-10 h-10 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" stroke-width="2"/></svg>
                    </div>
                    <p class="text-sm text-slate-600">Detail login akan dikirim ke Telegram/Email terdaftar.</p>
                </div>
                <input id="forgot-input" type="text" placeholder="Email / Chat ID Telegram" class="input-glass">
                <button onclick="window.handleForgotPassword()" class="w-full pill-glass-3d py-5 bg-amber-600 text-white font-black text-lg shadow-[0_6px_0_#92400e]">KIRIM PERMINTAAN</button>
            </div>
        </div>

        <!-- SCREEN: PRESENSI -->
        <div id="presensi-screen" class="screen screen-hidden overflow-y-auto scrollbar-hide !px-0">
            <div class="flex flex-col items-center pt-8 px-6 mb-4">
                <div class="rounded-[35px] relative photo-portrait-shadow overflow-hidden" style="width: 120px; height: 180px;">
                    <img id="user-photo" src="" class="w-full h-full object-cover bg-white">
                    <div id="photo-v" class="absolute bottom-2 right-2 w-8 h-8 bg-emerald-500 rounded-full border-2 border-white hidden items-center justify-center text-white text-xs font-black shadow-lg">V</div>
                </div>
                <div class="mt-5 text-center px-4">
                    <h2 id="user-name" class="text-2xl font-black text-slate-800 tracking-tight leading-none mb-1 uppercase">...</h2>
                    <p id="user-job" class="text-[10px] font-bold text-emerald-600 tracking-widest uppercase">...</p>
                    <div id="gps-status-container" class="mt-3 px-5 py-2 bg-white/50 rounded-full border border-white inline-flex items-center gap-2 shadow-sm">
                        <div id="gps-dot" class="w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse"></div>
                        <span id="gps-text" class="text-[10px] font-black uppercase tracking-tight">Kunci Lokasi GPS</span>
                        <span id="gps-v" class="hidden text-emerald-600 font-bold text-xs ml-1">V</span>
                    </div>
                </div>
            </div>

            <div class="px-6 mb-4">
                <button id="lock-gps-btn" onclick="window.getRealLocation()" class="w-full pill-glass-3d py-5 bg-emerald-600 text-white font-black text-sm uppercase tracking-widest !shadow-[0_6px_0_#064e3b]">AMBIL KOORDINAT (STEP 1)</button>
            </div>

            <div id="attendance-form" class="locked-section space-y-8 bg-white/20 border-y border-white/40 py-10 px-6 shadow-2xl mb-8 w-full rounded-[55px]">
                <div class="space-y-4">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Kategori Presensi <span id="status-v" class="step-check hidden ml-2">V Terpilih</span></label>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="btn-hadir" onclick="window.setStatus('Hadir', this)" class="status-btn pill-glass-3d py-6 font-black text-xs uppercase">Hadir</button>
                        <button id="btn-pulang" onclick="window.setStatus('Pulang', this)" class="status-btn pill-glass-3d py-6 font-black text-xs uppercase">Pulang</button>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <button id="btn-izin" onclick="window.setStatus('Izin', this)" class="status-btn pill-glass-3d py-4 font-bold text-[9px] uppercase">Izin</button>
                        <button id="btn-cuti" onclick="window.setStatus('Cuti', this)" class="status-btn pill-glass-3d py-4 font-bold text-[9px] uppercase">Cuti</button>
                        <button id="btn-sakit" onclick="window.setStatus('Sakit', this)" class="status-btn pill-glass-3d py-4 font-bold text-[9px] uppercase">Sakit</button>
                        <button id="btn-dinas" onclick="window.setStatus('Dinas', this)" class="status-btn pill-glass-3d py-4 font-bold text-[9px] uppercase">Dinas</button>
                        <button id="btn-margin" onclick="window.setStatus('Margin Error', this)" class="status-btn pill-glass-3d py-4 font-bold text-red-600 uppercase col-span-2 tracking-tighter">Margin Error</button>
                    </div>
                    <div id="duration-box" class="hidden mt-4 bg-white/30 p-4 rounded-3xl border border-white/50">
                         <label class="text-[10px] font-black text-blue-700 uppercase mb-2 block tracking-widest text-center">Rentang (Hari)</label>
                         <input id="rentang-waktu" type="number" min="1" max="30" value="1" class="input-glass !py-4 !text-center !text-lg !font-black !text-blue-800">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Catatan Aktivitas <span id="notes-v" class="step-check hidden ml-2">V Terisi</span></label>
                    <textarea id="attendance-notes" oninput="window.validateForm()" class="input-glass !h-36 resize-none focus:outline-none" placeholder="Tulis rincian tugas atau kendala hari ini..."></textarea>
                </div>

                <div class="space-y-4">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Lampiran Media <span id="media-v" class="step-check hidden ml-2">V Lengkap</span></label>
                    <div class="grid grid-cols-2 gap-5">
                        <div class="relative">
                            <button onclick="window.openCamera('selfie')" class="w-full pill-glass-3d aspect-square flex flex-col items-center justify-center gap-2 overflow-hidden">
                                <div id="preview-selfie" class="absolute inset-0 hidden"><img class="w-full h-full object-cover"></div>
                                <svg class="w-10 h-10 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke-width="1.5"/></svg>
                                <span class="text-[9px] font-black uppercase text-slate-500">Selfie</span>
                            </button>
                            <button id="retry-selfie" onclick="window.openCamera('selfie')" class="absolute -top-2 -right-2 bg-white text-red-500 p-2 rounded-full hidden shadow-lg border border-red-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="3"/></svg></button>
                        </div>
                        <div class="relative">
                            <button onclick="window.openCamera('kerja')" class="w-full pill-glass-3d aspect-square flex flex-col items-center justify-center gap-2 overflow-hidden">
                                <div id="preview-kerja" class="absolute inset-0 hidden"><img class="w-full h-full object-cover"></div>
                                <svg class="w-10 h-10 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" stroke-width="1.5"/></svg>
                                <span class="text-[9px] font-black uppercase text-slate-500">Lokasi</span>
                            </button>
                            <button id="retry-kerja" onclick="window.openCamera('kerja')" class="absolute -top-2 -right-2 bg-white text-red-500 p-2 rounded-full hidden shadow-lg border border-red-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="3"/></svg></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-6 pb-12">
                <button id="final-submit" onclick="window.confirmSubmitFlow()" class="w-full pill-glass-3d !bg-slate-900 !text-white py-6 font-black text-xl tracking-[0.2em] shadow-2xl opacity-50 pointer-events-none">KIRIM ABSENSI</button>
            </div>
        </div>
    </div>

    <script type="module">
        const API_URL = "https://script.google.com/macros/s/AKfycbzE8Ko__c6BgxbYIfz0Uvres49hsZ3yo_3JJ0eu6BbQVckKCqeL4Dhyu8bLSZsoZJ3qlw/exec";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'upt-psda-pro';
        
        let firebaseConfig;
        try { firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" }; }
        catch(e) { firebaseConfig = { apiKey: "" }; }

        // State
        let db, auth, user, html5QrCode = null;
        let currentUser = null, currentScreen = 'login-screen', selectedStatus = "", coordinates = "", selfieRaw = null, kerjaRaw = null, activeCameraMode = null, profilePhotoRaw = null;
        let serverTime = null, dailyStatus = { hasHadir: false, hasPulang: false, hasSpecial: false, hasMargin: false };

        const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, getDoc } = window.firebaseInit;

        // Init Firebase
        if (firebaseConfig.apiKey) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            onAuthStateChanged(auth, async (u) => {
                user = u;
                if (user) {
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'session', 'login_data');
                    try {
                        const snap = await getDoc(docRef);
                        if (snap.exists()) {
                            const data = snap.data();
                            document.getElementById('login-username').value = data.user || "";
                            document.getElementById('login-password').value = data.pass || "";
                            document.getElementById('save-session').checked = true;
                        }
                    } catch (e) {}
                } else {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                }
            });
        }

        // --- UI HELPERS ---
        window.showToast = (msg, type = "info", title = "Pemberitahuan") => {
            const toast = document.getElementById('toast-element');
            const box = document.getElementById('toast-icon-box');
            document.getElementById('toast-text').innerText = msg;
            document.getElementById('toast-title').innerText = title;
            box.className = "w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg " + (type === "success" ? "bg-emerald-500 shadow-[0_0_20px_rgba(16,185,129,0.5)]" : "bg-red-500 shadow-[0_0_20px_rgba(239,68,68,0.5)]");
            box.innerText = type === "success" ? "✓" : "!";
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4500);
        };

        window.showLoading = (s, text = "Sinkronisasi Server...") => { 
            const loader = document.getElementById('global-loader');
            const lText = document.getElementById('loader-text');
            if (lText) lText.innerText = text;
            loader.style.display = s ? 'flex' : 'none'; 
        };

        window.navigateTo = (id) => {
            const cur = document.getElementById(currentScreen), next = document.getElementById(id);
            if (!next) return;
            cur.classList.remove('screen-active'); cur.classList.add('screen-prev');
            next.classList.remove('screen-hidden', 'screen-prev'); next.classList.add('screen-active');
            currentScreen = id;
        };

        window.closeModal = () => { document.getElementById('modal-confirm').style.display = 'none'; };

        // --- QR SCANNER ---
        window.startQRScanner = () => {
            document.getElementById('qr-scanner-overlay').style.display = 'flex';
            html5QrCode = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, async (token) => {
                window.stopQRScanner();
                window.showLoading(true, "Memvalidasi Token...");
                try {
                    const res = await (await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "login", type: "qr", token }) })).json();
                    if (res.status === "success") handleLoginSuccess(res.data);
                    else window.showToast(res.message, "error");
                } catch (e) { window.showToast("Gagal terhubung.", "error"); }
                window.showLoading(false);
            }, (err) => {});
        };

        window.stopQRScanner = () => {
            if (html5QrCode) html5QrCode.stop().then(() => { document.getElementById('qr-scanner-overlay').style.display = 'none'; html5QrCode = null; });
            else document.getElementById('qr-scanner-overlay').style.display = 'none';
        };

        // --- AUTH ---
        window.handleLogin = async () => {
            const userInp = document.getElementById('login-username').value;
            const passInp = document.getElementById('login-password').value;
            const saveCheck = document.getElementById('save-session').checked;
            if (!userInp || !passInp) return window.showToast("Isi form lengkap.", "error");
            window.showLoading(true, "Verifikasi Akun...");
            try {
                const res = await (await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "login", username: userInp, password: passInp }) })).json();
                if (res.status === "success") {
                    if (db && user) {
                        const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'session', 'login_data');
                        await setDoc(ref, saveCheck ? { user: userInp, pass: passInp } : {});
                    }
                    handleLoginSuccess(res.data);
                } else window.showToast(res.message, "error");
            } catch (e) { window.showToast("Server tidak merespon.", "error"); }
            window.showLoading(false);
        };

        async function handleLoginSuccess(data) {
            currentUser = data;
            document.getElementById('user-name').innerText = currentUser.Nama;
            document.getElementById('user-job').innerText = currentUser.Jabatan;
            document.getElementById('user-photo').src = currentUser.FotoUrl;
            const sRes = await (await fetch(API_URL + "?action=getTodayStatus&nama=" + encodeURIComponent(currentUser.Nama))).json();
            dailyStatus = sRes;
            applyBusinessRules();
            window.navigateTo('presensi-screen');
            window.showToast("Selamat Datang!", "success");
        }

        function applyBusinessRules() {
            if (dailyStatus.hasSpecial) {
                document.querySelectorAll('.status-btn').forEach(b => b.disabled = true);
                window.showToast("Sudah absen khusus hari ini.", "error"); return;
            }
            document.getElementById('btn-hadir').disabled = dailyStatus.hasHadir;
            document.getElementById('btn-pulang').disabled = dailyStatus.hasPulang;
            document.getElementById('btn-margin').disabled = dailyStatus.hasHadir || dailyStatus.hasMargin;
        }

        // --- GPS & CAMERA ---
        window.getRealLocation = () => {
            if (!navigator.geolocation) return window.showToast("GPS tidak didukung.", "error");
            window.showLoading(true, "Melacak GPS...");
            navigator.geolocation.getCurrentPosition(async (p) => {
                coordinates = `${p.coords.latitude}, ${p.coords.longitude}`;
                document.getElementById('gps-text').innerText = "GPS TERKUNCI";
                document.getElementById('gps-dot').className = "w-2.5 h-2.5 bg-emerald-500 rounded-full shadow-[0_0_10px_#10b981]";
                document.getElementById('gps-v').classList.remove('hidden');
                document.getElementById('lock-gps-btn').style.display = "none";
                document.getElementById('attendance-form').className = "unlocked-section space-y-8 bg-white/20 border-y border-white/40 py-10 px-6 shadow-2xl mb-8 w-full rounded-[55px]";
                try {
                    const t = await (await fetch(API_URL + "?action=getServerTime")).json();
                    serverTime = t.formattedTime;
                    const [h, m] = serverTime.split(':').map(Number);
                    if (h*60+m > 450) window.showToast(`Terlambat: ${h*60+m-450} mnt.`, "error", "Waktu Server");
                } catch(e) { serverTime = new Date().toLocaleTimeString('id-ID', {hour12: false}); }
                window.showLoading(false);
            }, () => { window.showLoading(false); window.showToast("Gagal lokasi. Aktifkan GPS.", "error"); }, { enableHighAccuracy: true, timeout: 35000 });
        };

        window.setStatus = (s, el) => {
            if (s === 'Pulang' && !dailyStatus.hasHadir && !dailyStatus.hasMargin && selectedStatus !== 'Margin Error') return window.showToast("Wajib Hadir dulu.", "error");
            selectedStatus = s;
            document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active-hadir', 'active-pulang', 'active-special', 'active-error'));
            el.classList.add(s === 'Hadir' ? 'active-hadir' : (s === 'Pulang' ? 'active-pulang' : (s === 'Margin Error' ? 'active-error' : 'active-special')));
            document.getElementById('status-v').classList.remove('hidden');
            document.getElementById('duration-box').classList.toggle('hidden', !['Izin', 'Cuti', 'Sakit', 'Dinas'].includes(s));
            window.validateForm();
        };

        window.openCamera = async (mode) => {
            activeCameraMode = mode;
            document.getElementById('camera-overlay').style.display = 'flex';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode === 'kerja' ? 'environment' : 'user' } });
                document.getElementById('video-preview').srcObject = stream;
            } catch(e) { window.showToast("Izin kamera ditolak.", "error"); window.closeCamera(); }
        };

        window.closeCamera = () => {
            const v = document.getElementById('video-preview');
            if (v.srcObject) v.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('camera-overlay').style.display = 'none';
        };

        window.takePicture = () => {
            const v = document.getElementById('video-preview'), c = document.createElement('canvas'), ctx = c.getContext('2d');
            const targetW = 800, targetH = 1200; // Resolusi Watermark Lebih Tinggi
            c.width = targetW; c.height = targetH;
            
            // --- Logic Smart Crop Portrait ---
            const sW = v.videoWidth, sH = v.videoHeight;
            const targetRatio = targetW / targetH;
            let dW, dH, dX, dY;
            if (sW / sH > targetRatio) { dH = sH; dW = sH * targetRatio; dX = (sW - dW) / 2; dY = 0; }
            else { dW = sW; dH = sW / targetRatio; dX = 0; dY = (sH - dH) / 2; }
            ctx.drawImage(v, dX, dY, dW, dH, 0, 0, targetW, targetH);
            
            // --- DESIGN WATERMARK PRO ---
            // 1. Overlay Gradient Bottom (Mewah)
            const grad = ctx.createLinearGradient(0, targetH * 0.65, 0, targetH);
            grad.addColorStop(0, "rgba(0, 0, 0, 0)");
            grad.addColorStop(0.3, "rgba(0, 0, 0, 0.4)");
            grad.addColorStop(1, "rgba(0, 0, 0, 0.9)");
            ctx.fillStyle = grad;
            ctx.fillRect(0, targetH * 0.6, targetW, targetH * 0.4);

            // 2. Garis Aksen Emerald
            ctx.fillStyle = "#10b981";
            ctx.fillRect(40, targetH - 240, 6, 160);

            // 3. Nama Pegawai (Header)
            ctx.fillStyle = "#FFFFFF";
            ctx.font = "800 42px Poppins";
            const displayName = (currentUser ? currentUser.Nama : "REGISTRASI").toUpperCase();
            ctx.fillText(displayName, 65, targetH - 195);

            // 4. Jabatan & Status
            ctx.font = "600 26px Poppins";
            ctx.fillStyle = "#E2E8F0";
            const jobStatus = (currentUser ? currentUser.Jabatan : "CALON") + " | " + selectedStatus.toUpperCase();
            ctx.fillText(jobStatus, 65, targetH - 150);

            // 5. Jam Server & Lokasi (Data Teknis)
            ctx.font = "400 20px Poppins";
            ctx.fillStyle = "#CBD5E1";
            ctx.fillText("WAKTU: " + (serverTime || "--:--") + " WIB", 65, targetH - 110);
            ctx.fillText("KOORD: " + (coordinates || "GPS UNLOCKED"), 65, targetH - 80);

            // 6. Verified Badge (Capsule Style)
            const badgeText = "✓ UPT PSDA BONDOYUDO VERIFIED";
            ctx.font = "bold 14px Poppins";
            const bWidth = ctx.measureText(badgeText).width + 30;
            ctx.fillStyle = "rgba(16, 185, 129, 0.2)";
            roundRect(ctx, 60, targetH - 55, bWidth, 32, 16, true);
            ctx.fillStyle = "#10b981";
            ctx.fillText(badgeText, 75, targetH - 33);

            const data = c.toDataURL('image/jpeg', 0.85);
            if (activeCameraMode === 'profile') {
                profilePhotoRaw = data; document.getElementById('preview-profile').classList.remove('hidden');
                document.getElementById('preview-profile').querySelector('img').src = data;
                document.getElementById('placeholder-reg-photo').classList.add('hidden');
            } else if (activeCameraMode === 'selfie') {
                selfieRaw = data; document.getElementById('preview-selfie').classList.remove('hidden');
                document.getElementById('preview-selfie').querySelector('img').src = data;
                document.getElementById('retry-selfie').classList.remove('hidden');
                document.getElementById('photo-v').classList.remove('hidden');
            } else {
                kerjaRaw = data; document.getElementById('preview-kerja').classList.remove('hidden');
                document.getElementById('preview-kerja').querySelector('img').src = data;
                document.getElementById('retry-kerja').classList.remove('hidden');
            }
            window.closeCamera(); window.validateForm();
        };

        // Helper Canvas RoundRect
        function roundRect(ctx, x, y, width, height, radius, fill) {
            ctx.beginPath(); ctx.moveTo(x + radius, y); ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius); ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height); ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius); ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y); ctx.closePath();
            if (fill) ctx.fill();
        }

        window.validateForm = () => {
            const hasNotes = document.getElementById('attendance-notes').value.length >= 5;
            document.getElementById('notes-v').classList.toggle('hidden', !hasNotes);
            document.getElementById('media-v').classList.toggle('hidden', !(selfieRaw && kerjaRaw));
            const btn = document.getElementById('final-submit');
            if (selectedStatus && hasNotes && selfieRaw && kerjaRaw) {
                btn.classList.replace('opacity-50', 'opacity-100'); btn.classList.replace('pointer-events-none', 'pointer-events-auto');
            } else { btn.classList.replace('opacity-100', 'opacity-50'); btn.classList.add('pointer-events-none'); }
        };

        window.confirmSubmitFlow = () => {
            document.getElementById('modal-msg').innerText = `Kirim data ${selectedStatus.toUpperCase()} ke server?`;
            document.getElementById('confirm-submit-btn').onclick = () => { window.closeModal(); window.submitAttendance(); };
            document.getElementById('modal-confirm').style.display = 'flex';
        };

        window.submitAttendance = async () => {
            window.showLoading(true, "Mengirim Presensi...");
            const body = { action: "submitAttendance", nama: currentUser.Nama, jabatan: currentUser.Jabatan, status: selectedStatus, koordinat: coordinates, fotoSelfie: selfieRaw, fotoKerja: kerjaRaw, keterangan: document.getElementById('attendance-notes').value + (['Izin','Cuti','Sakit','Dinas'].includes(selectedStatus) ? ` [${document.getElementById('rentang-waktu').value} Hari]` : "") };
            try {
                const res = await (await fetch(API_URL, { method: "POST", body: JSON.stringify(body) })).json();
                if (res.status === "success") { window.showToast(res.message, "success"); setTimeout(() => location.reload(), 4500); }
                else window.showToast(res.message, "error");
            } catch (e) { window.showToast("Gagal kirim.", "error"); }
            window.showLoading(false);
        };

        // --- REGISTRATION ---
        window.toggleManual = (sel, id) => document.getElementById(id).classList.toggle('hidden', sel.value !== 'manual');
        window.handleFileUpload = (e) => {
            const reader = new FileReader();
            reader.onload = ev => {
                profilePhotoRaw = ev.target.result; document.getElementById('preview-profile').classList.remove('hidden');
                document.getElementById('preview-profile').querySelector('img').src = ev.target.result;
                document.getElementById('placeholder-reg-photo').classList.add('hidden');
            }; reader.readAsDataURL(e.target.files[0]);
        };

        window.handleRegister = async () => {
            const j = document.getElementById('reg-jabatan').value, w = document.getElementById('reg-wilayah').value;
            const body = { action: "register", ID: document.getElementById('reg-id').value, Nama: document.getElementById('reg-nama').value, Jabatan: j === 'manual' ? document.getElementById('manual-jabatan').value : j, Wilayah: w === 'manual' ? document.getElementById('manual-wilayah').value : w, Email: document.getElementById('reg-email').value, NomorHP: document.getElementById('reg-hp').value, LokasiPenempatan: document.getElementById('reg-lokasi').value, Password: document.getElementById('reg-password').value, FotoUrl: profilePhotoRaw };
            if (!body.Nama || !profilePhotoRaw) return window.showToast("Isi Nama & Foto.", "error");
            window.showLoading(true, "Mendaftar...");
            try {
                const res = await (await fetch(API_URL, { method: "POST", body: JSON.stringify(body) })).json();
                if (res.status === "success") {
                    document.getElementById('qr-display-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${res.qrToken}`;
                    document.getElementById('modal-qr-success').style.display = 'flex';
                } else window.showToast(res.message, "error");
            } catch (e) { window.showToast("Gagal mendaftar.", "error"); }
            window.showLoading(false);
        };

        window.handleForgotPassword = async () => {
            const inp = document.getElementById('forgot-input').value;
            if (!inp) return window.showToast("Isi data kontak.", "error");
            window.showLoading(true, "Mengecek...");
            try {
                const res = await (await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "forgotPassword", input: inp }) })).json();
                window.showToast(res.message, res.status === "success" ? "success" : "error");
            } catch (e) { window.showToast("Gagal koneksi.", "error"); }
            window.showLoading(false);
        };
    </script>
</body>
</html>
