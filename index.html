<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UPT PSDA - Pro Attendance System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-highlight: rgba(255, 255, 255, 0.7);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #cbd5e1;
            margin: 0; padding: 0;
            height: 100dvh;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        .bg-decoration {
            position: absolute; width: 500px; height: 500px; border-radius: 50%;
            filter: blur(120px); z-index: -1; animation: move 25s infinite alternate;
        }
        @keyframes move { from { transform: translate(-50%, -50%); } to { transform: translate(50%, 50%); } }

        .app-container {
            width: 100%; height: 100dvh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(40px) saturate(160%);
            -webkit-backdrop-filter: blur(40px) saturate(160%);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            border-left: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-border);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (min-width: 1024px) {
            .app-container { width: 420px; height: 880px; max-height: 95vh; border-radius: 40px; border: 2px solid var(--glass-border); box-shadow: 0 50px 100px rgba(0,0,0,0.25); }
        }

        .pill-glass-3d {
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); border-radius: 22px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.15), inset 0 1px 1px var(--glass-highlight);
            transition: all 0.1s ease; position: relative; overflow: hidden;
        }
        .pill-glass-3d:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 3px 0 rgba(0,0,0,0.15); }
        .pill-glass-3d:disabled { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; }

        .input-glass {
            background: rgba(255, 255, 255, 0.15); border: 1px solid var(--glass-border);
            border-radius: 15px; backdrop-filter: blur(10px); box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
            width: 100%; padding: 14px; font-weight: 600; color: #1e293b;
        }

        .screen {
            position: absolute; inset: 0; padding: 20px;
            display: flex; flex-direction: column;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease;
            will-change: transform, opacity; z-index: 1;
        }
        .screen-hidden { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .screen-prev { transform: translateX(-30%) scale(0.9); opacity: 0; pointer-events: none; }
        .screen-active { transform: translateX(0); opacity: 1; z-index: 10; }

        .locked-section { opacity: 0.3; pointer-events: none; filter: blur(4px); transition: all 0.5s ease; }
        .unlocked-section { opacity: 1; pointer-events: auto; filter: none; }

        #camera-overlay { position: absolute; inset: 0; background: black; z-index: 1000; display: none; flex-direction: column; }
        
        .guide-frame {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70vw; height: 105vw; max-width: 280px; max-height: 420px;
            border: 3px solid #10b981; border-radius: 25px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.7); pointer-events: none;
        }

        .toast-pro {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-150px);
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 15px 25px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); z-index: 10000;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: max-content; max-width: 90vw; border: 1px solid white;
        }
        .toast-pro.show { transform: translateX(-50%) translateY(0); }

        /* Drop Shadow Portrait Gelap yang Dalam */
        .photo-portrait-shadow {
            box-shadow: 0 35px 70px -15px rgba(0, 0, 0, 0.7), 0 20px 40px -20px rgba(0, 0, 0, 0.8);
            border: 4px solid rgba(255,255,255,0.3);
        }

        #modal-confirm {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px);
            z-index: 9500; display: none; align-items: center; justify-content: center; padding: 20px;
        }

        .active-hadir { background: #10b981 !important; color: white !important; box-shadow: 0 6px 0 #065f46 !important; }
        .active-pulang { background: #f59e0b !important; color: white !important; box-shadow: 0 6px 0 #92400e !important; }
        .active-special { background: #3b82f6 !important; color: white !important; box-shadow: 0 6px 0 #1e40af !important; }
        .active-error { background: #334155 !important; color: white !important; box-shadow: 0 6px 0 #0f172a !important; }

        .step-check { color: #10b981; font-weight: bold; font-size: 14px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div class="bg-decoration bg-blue-500" style="top: 0%; left: 0%;"></div>
    <div class="bg-decoration bg-emerald-400" style="bottom: 0%; right: 0%;"></div>

    <!-- TOAST ELEMENT -->
    <div id="toast-element" class="toast-pro">
        <div id="toast-icon-box" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">!</div>
        <div class="flex flex-col">
            <p id="toast-title" class="text-[10px] font-black uppercase text-slate-400 tracking-widest leading-none mb-1">Pemberitahuan</p>
            <p id="toast-text" class="text-xs font-bold text-slate-800 tracking-tight"></p>
        </div>
    </div>

    <!-- MODAL CONFIRMATION -->
    <div id="modal-confirm">
        <div class="bg-white rounded-[35px] p-8 w-full max-w-sm shadow-2xl space-y-6">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2"/></svg>
            </div>
            <div class="text-center space-y-2">
                <h3 class="font-black text-xl text-slate-800 uppercase tracking-tighter">Konfirmasi E-Presensi</h3>
                <p id="modal-msg" class="text-sm text-slate-500 font-medium"></p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-4 font-bold text-slate-400 uppercase text-xs">Batal</button>
                <button id="confirm-submit-btn" class="flex-1 pill-glass-3d bg-slate-900 text-white font-black uppercase text-xs !shadow-[0_4px_0_#000]">Ya, Kirim</button>
            </div>
        </div>
    </div>

    <!-- GLOBAL LOADER -->
    <div id="global-loader" class="loading-overlay fixed inset-0 bg-slate-900/60 backdrop-blur-md hidden flex-col items-center justify-center z-[9000] text-white">
        <div class="spinner mb-4"></div>
        <p id="loader-text" class="font-bold tracking-widest text-[10px] uppercase">Sinkronisasi Server...</p>
    </div>

    <div class="app-container">
        
        <!-- CAMERA OVERLAY -->
        <div id="camera-overlay">
            <video id="video-preview" class="w-full h-full object-cover" autoplay playsinline></video>
            <div class="guide-frame"></div>
            <div class="absolute bottom-10 left-0 right-0 flex justify-around items-center px-10">
                <button onclick="closeCamera()" class="p-4 bg-white/20 rounded-full text-white backdrop-blur-md"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2"/></svg></button>
                <button onclick="takePicture()" class="w-20 h-20 bg-white rounded-full border-8 border-white/30 shadow-2xl active:scale-90 transition"></button>
                <div class="w-14"></div>
            </div>
        </div>

        <!-- SCREEN: LOGIN -->
        <div id="login-screen" class="screen screen-active justify-center space-y-8 px-6">
            <div class="flex flex-col items-center">
                <div class="w-24 h-24 bg-slate-900 rounded-[32px] flex items-center justify-center mb-4 shadow-2xl rotate-3 transition hover:rotate-0 duration-500">
                    <svg viewBox="0 0 24 24" class="w-14 h-14 text-white fill-current"><path d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z" /></svg>
                </div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tighter text-center uppercase leading-none">UPT PSDA<br><span class="text-emerald-600">BONDOYUDO</span></h1>
            </div>
            <div class="space-y-4">
                <input id="login-username" type="text" placeholder="Username / Email / HP" class="input-glass">
                <input id="login-password" type="password" placeholder="Password" class="input-glass">
                <button onclick="handleLogin()" class="w-full pill-glass-3d py-4 bg-slate-900 text-white font-black text-lg shadow-[0_6px_0_#000]">MASUK</button>
            </div>
            <div class="flex justify-between items-end pb-4 pt-10 px-2">
                <button onclick="navigateTo('forgot-screen')" class="text-left group focus:outline-none"><p class="text-slate-800 font-bold text-xs leading-none">Password</p><p class="text-[10px] text-slate-500 uppercase group-hover:underline">Lupa Sandi?</p></button>
                <button onclick="navigateTo('register-screen')" class="text-right group focus:outline-none"><p class="text-emerald-700 font-bold text-xs leading-none">Register</p><p class="text-[10px] text-slate-500 uppercase underline">Daftar Akun</p></button>
            </div>
        </div>

        <!-- SCREEN: REGISTER -->
        <div id="register-screen" class="screen screen-hidden overflow-y-auto scrollbar-hide">
            <div class="flex items-center gap-4 mb-8" onclick="navigateTo('login-screen')">
                <div class="p-2 bg-slate-900/10 rounded-xl"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg></div>
                <h2 class="text-xl font-black text-slate-800 tracking-tight">Pendaftaran Pegawai</h2>
            </div>
            <div class="space-y-6 pb-12">
                <div class="flex flex-col items-center space-y-4">
                    <div class="w-32 h-48 rounded-[25px] relative photo-portrait-shadow overflow-hidden bg-slate-400">
                        <div id="preview-profile" class="absolute inset-0 hidden"><img class="w-full h-full object-cover"></div>
                        <div id="placeholder-reg-photo" class="absolute inset-0 flex items-center justify-center">
                            <svg id="placeholder-icon" class="w-12 h-12 text-slate-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="openCamera('profile')" class="pill-glass-3d p-3 bg-white/50 text-slate-700 flex items-center gap-2 text-xs font-bold"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Ambil Foto</button>
                        <button onclick="document.getElementById('file-upload-profile').click()" class="pill-glass-3d p-3 bg-white/50 text-slate-700 flex items-center gap-2 text-xs font-bold"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>Unggah</button>
                        <input type="file" id="file-upload-profile" class="hidden" accept="image/*" onchange="handleFileUpload(event)">
                    </div>
                </div>
                <div class="space-y-4">
                    <input id="reg-id" type="text" placeholder="ID Pegawai (Contoh: P001)" class="input-glass">
                    <input id="reg-nama" type="text" placeholder="Nama Lengkap" class="input-glass">
                    <select id="reg-jabatan" class="input-glass" onchange="toggleManual(this, 'manual-jabatan')">
                        <option value="" disabled selected>Pilih Jabatan</option>
                        <option value="PPA">PPA</option><option value="Pekarya">Pekarya</option><option value="Staf Pengamat">Staf Pengamat</option><option value="manual">Isi manual...</option>
                    </select>
                    <input id="manual-jabatan" type="text" placeholder="Ketik Jabatan" class="input-glass hidden border-emerald-400">
                    <select id="reg-wilayah" class="input-glass" onchange="toggleManual(this, 'manual-wilayah')">
                        <option value="" disabled selected>Pilih Wilayah</option>
                        <option value="Bangorejo">Bangorejo</option><option value="Cluring">Cluring</option><option value="Pesanggaran">Pesanggaran</option><option value="Porolinggo">Porolinggo</option><option value="manual">Isi manual...</option>
                    </select>
                    <input id="manual-wilayah" type="text" placeholder="Ketik Wilayah" class="input-glass hidden border-emerald-400">
                    <input id="reg-email" type="email" placeholder="Email Aktif" class="input-glass">
                    <input id="reg-hp" type="tel" placeholder="Nomor HP (Contoh: 08...)" class="input-glass">
                    <input id="reg-lokasi" type="text" placeholder="Lokasi Penempatan" class="input-glass">
                    <input id="reg-password" type="password" placeholder="Password Baru" class="input-glass">
                </div>
                <button onclick="handleRegister()" class="w-full pill-glass-3d py-5 bg-emerald-600 text-white font-black text-lg shadow-[0_6px_0_#064e3b]">DAFTAR SEKARANG</button>
            </div>
        </div>

        <!-- SCREEN: FORGOT PASSWORD -->
        <div id="forgot-screen" class="screen screen-hidden">
            <div class="flex items-center gap-4 mb-10" onclick="navigateTo('login-screen')">
                <div class="p-2 bg-slate-900/10 rounded-xl"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg></div>
                <h2 class="text-xl font-black text-slate-800">Reset Password</h2>
            </div>
            <div class="flex-1 flex flex-col justify-center space-y-6">
                <div class="text-center space-y-2">
                    <div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                        <svg class="w-10 h-10 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" stroke-width="2"/></svg>
                    </div>
                    <p class="text-sm text-slate-600">Masukkan kontak terdaftar (Email/HP) untuk pemulihan.</p>
                </div>
                <input id="forgot-input" type="text" placeholder="Email / Nomor HP" class="input-glass">
                <button onclick="handleForgotPassword()" class="w-full pill-glass-3d py-5 bg-amber-600 text-white font-black text-lg shadow-[0_6px_0_#92400e]">KIRIM PERMINTAAN</button>
            </div>
        </div>

        <!-- SCREEN: PRESENSI -->
        <div id="presensi-screen" class="screen screen-hidden overflow-y-auto scrollbar-hide !px-0">
            <div class="flex flex-col items-center pt-8 px-6 mb-4">
                <div class="rounded-[35px] relative photo-portrait-shadow overflow-hidden" style="width: 120px; height: 180px;">
                    <img id="user-photo" src="" class="w-full h-full object-cover bg-slate-100">
                    <div id="photo-v" class="absolute bottom-2 right-2 w-8 h-8 bg-emerald-500 rounded-full border-2 border-white hidden items-center justify-center text-white text-xs font-black shadow-lg">V</div>
                </div>
                <div class="mt-5 text-center px-4">
                    <h2 id="user-name" class="text-2xl font-black text-slate-800 tracking-tight leading-none mb-1 uppercase">...</h2>
                    <p id="user-job" class="text-[10px] font-bold text-emerald-600 tracking-widest uppercase">...</p>
                    <div id="gps-status-container" class="mt-3 px-5 py-2 bg-white/50 rounded-full border border-white inline-flex items-center gap-2 shadow-sm">
                        <div id="gps-dot" class="w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse"></div>
                        <span id="gps-text" class="text-[10px] font-black uppercase tracking-tight">Menunggu GPS</span>
                        <span id="gps-v" class="hidden text-emerald-600 font-bold text-xs ml-1">V</span>
                    </div>
                </div>
            </div>

            <div class="px-6 mb-4">
                <button id="lock-gps-btn" onclick="getRealLocation()" class="w-full pill-glass-3d py-5 bg-emerald-600 text-white font-black text-sm uppercase tracking-widest !shadow-[0_6px_0_#064e3b]">KUNCI LOKASI GPS (STEP 1)</button>
            </div>

            <div id="attendance-form" class="locked-section space-y-8 bg-white/20 border-y border-white/40 py-10 px-6 shadow-2xl mb-8 w-full rounded-[55px]">
                <div class="space-y-4">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Pilih Status <span id="status-v" class="step-check hidden ml-2">V Terpilih</span></label>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="btn-hadir" onclick="setStatus('Hadir', this)" class="status-btn pill-glass-3d py-6 font-black text-xs uppercase">Hadir</button>
                        <button id="btn-pulang" onclick="setStatus('Pulang', this)" class="status-btn pill-glass-3d py-6 font-black text-xs uppercase">Pulang</button>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <button id="btn-izin" onclick="setStatus('Izin', this)" class="status-btn pill-glass-3d py-4 font-bold text-[9px] uppercase">Izin</button>
                        <button id="btn-cuti" onclick="setStatus('Cuti', this)" class="status-btn pill-glass-3d py-4 font-bold text-[9px] uppercase">Cuti</button>
                        <button id="btn-sakit" onclick="setStatus('Sakit', this)" class="status-btn pill-glass-3d py-4 font-bold text-[9px] uppercase">Sakit</button>
                        <button id="btn-dinas" onclick="setStatus('Dinas', this)" class="status-btn pill-glass-3d py-4 font-bold text-[9px] uppercase">Dinas</button>
                        <button id="btn-margin" onclick="setStatus('Margin Error', this)" class="status-btn pill-glass-3d py-4 font-bold text-red-600 uppercase col-span-2 tracking-tighter">Margin Error</button>
                    </div>
                    <div id="duration-box" class="hidden mt-4 bg-white/30 p-4 rounded-3xl border border-white/50">
                         <label class="text-[10px] font-black text-blue-700 uppercase mb-2 block tracking-widest text-center">Rentang Waktu (Hari)</label>
                         <input id="rentang-waktu" type="number" min="1" max="30" value="1" class="input-glass !py-4 !text-center !text-lg !font-black !text-blue-800">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Keterangan Aktivitas <span id="notes-v" class="step-check hidden ml-2">V Terisi</span></label>
                    <textarea id="attendance-notes" oninput="validateForm()" class="input-glass !h-36 resize-none focus:outline-none" placeholder="Tulis catatan harian Anda..."></textarea>
                </div>

                <div class="space-y-4">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Lampiran Dokumentasi <span id="media-v" class="step-check hidden ml-2">V Lengkap</span></label>
                    <div class="grid grid-cols-2 gap-5">
                        <div class="relative">
                            <button onclick="openCamera('selfie')" class="w-full pill-glass-3d aspect-square flex flex-col items-center justify-center gap-2 overflow-hidden">
                                <div id="preview-selfie" class="absolute inset-0 hidden"><img class="w-full h-full object-cover"></div>
                                <svg class="w-10 h-10 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke-width="1.5"/></svg>
                                <span class="text-[9px] font-black uppercase text-slate-500">Selfie</span>
                            </button>
                            <button id="retry-selfie" onclick="openCamera('selfie')" class="absolute -top-2 -right-2 bg-white text-red-500 p-2 rounded-full hidden shadow-lg border border-red-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="3"/></svg></button>
                        </div>
                        <div class="relative">
                            <button onclick="openCamera('kerja')" class="w-full pill-glass-3d aspect-square flex flex-col items-center justify-center gap-2 overflow-hidden">
                                <div id="preview-kerja" class="absolute inset-0 hidden"><img class="w-full h-full object-cover"></div>
                                <svg class="w-10 h-10 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" stroke-width="1.5"/></svg>
                                <span class="text-[9px] font-black uppercase text-slate-500">Lokasi</span>
                            </button>
                            <button id="retry-kerja" onclick="openCamera('kerja')" class="absolute -top-2 -right-2 bg-white text-red-500 p-2 rounded-full hidden shadow-lg border border-red-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="3"/></svg></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-6 pb-12">
                <button id="final-submit" onclick="confirmSubmitFlow()" class="w-full pill-glass-3d !bg-slate-900 !text-white py-6 font-black text-xl tracking-[0.2em] shadow-2xl opacity-50 pointer-events-none">KIRIM ABSENSI</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzE8Ko__c6BgxbYIfz0Uvres49hsZ3yo_3JJ0eu6BbQVckKCqeL4Dhyu8bLSZsoZJ3qlw/exec";
        let currentUser = null, currentScreen = 'login-screen', selectedStatus = "", coordinates = "", selfieRaw = null, kerjaRaw = null, activeCameraMode = null, profilePhotoRaw = null;
        let serverTime = null, dailyStatus = { hasHadir: false, hasPulang: false, hasSpecial: false, hasMargin: false };

        function showToast(msg, type = "info", title = "Pemberitahuan") {
            const toast = document.getElementById('toast-element');
            const box = document.getElementById('toast-icon-box');
            document.getElementById('toast-text').innerText = msg;
            document.getElementById('toast-title').innerText = title;
            box.className = "w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg " + (type === "success" ? "bg-emerald-500 shadow-[0_0_20px_rgba(16,185,129,0.5)]" : "bg-red-500 shadow-[0_0_20px_rgba(239,68,68,0.5)]");
            box.innerText = type === "success" ? "✓" : "!";
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 5000);
        }

        function closeModal() { document.getElementById('modal-confirm').style.display = 'none'; }
        function showLoading(s, text = "Sinkronisasi Server...") { 
            const loader = document.getElementById('global-loader');
            document.getElementById('loader-text').innerText = text;
            loader.style.display = s ? 'flex' : 'none'; 
        }
        
        function navigateTo(id) {
            const cur = document.getElementById(currentScreen), next = document.getElementById(id);
            cur.classList.remove('screen-active'); cur.classList.add('screen-prev');
            next.classList.remove('screen-hidden', 'screen-prev'); next.classList.add('screen-active');
            currentScreen = id;
        }

        async function handleLogin() {
            const user = document.getElementById('login-username').value, pass = document.getElementById('login-password').value;
            if (!user || !pass) return showToast("Masukkan kredensial lengkap.", "error");
            
            showLoading(true, "Memvalidasi Akun...");
            try {
                const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "login", username: user, password: pass }) });
                const res = await response.json();
                if (res.status === "success") {
                    currentUser = res.data;
                    document.getElementById('user-name').innerText = currentUser.Nama;
                    document.getElementById('user-job').innerText = currentUser.Jabatan;
                    document.getElementById('user-photo').src = currentUser.FotoUrl;
                    
                    const statusResp = await fetch(API_URL + "?action=getTodayStatus&nama=" + encodeURIComponent(currentUser.Nama));
                    dailyStatus = await statusResp.json();
                    
                    applyBusinessRules();
                    navigateTo('presensi-screen');
                    showToast("Sesi Sinkron. Kunci lokasi GPS Anda.", "success", "Login Berhasil");
                } else showToast(res.message, "error");
            } catch (e) { showToast("Gagal terhubung ke server. Cek koneksi.", "error"); }
            showLoading(false);
        }

        function applyBusinessRules() {
            if (dailyStatus.hasSpecial) {
                document.querySelectorAll('.status-btn').forEach(b => b.disabled = true);
                showToast("Anda sudah absen khusus (Izin/Sakit/Cuti/Dinas). Akses hari ini ditutup.", "error", "Aturan Harian");
                return;
            }
            document.getElementById('btn-hadir').disabled = dailyStatus.hasHadir;
            document.getElementById('btn-pulang').disabled = dailyStatus.hasPulang;
            document.getElementById('btn-margin').disabled = dailyStatus.hasHadir || dailyStatus.hasMargin;
        }

        async function getRealLocation() {
            if (!navigator.geolocation) {
                return showToast("GPS tidak didukung di browser ini.", "error", "Error GPS");
            }

            showLoading(true, "Mencari Koordinat GPS...");
            
            // Pengaturan GPS diperkuat untuk HP
            const geoOptions = {
                enableHighAccuracy: true,
                timeout: 35000, // Timeout ditingkatkan ke 35 detik
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(async (p) => {
                coordinates = `${p.coords.latitude}, ${p.coords.longitude}`;
                document.getElementById('gps-text').innerText = "GPS TERKUNCI";
                document.getElementById('gps-dot').className = "w-2.5 h-2.5 bg-emerald-500 rounded-full shadow-[0_0_10px_#10b981]";
                document.getElementById('gps-v').classList.remove('hidden');
                document.getElementById('lock-gps-btn').style.display = "none";
                document.getElementById('attendance-form').className = "unlocked-section space-y-8 bg-white/20 border-y border-white/40 py-10 px-6 shadow-2xl mb-8 w-full rounded-[55px]";
                
                try {
                    const tResp = await fetch(API_URL + "?action=getServerTime");
                    const tData = await tResp.json();
                    serverTime = tData.formattedTime;
                    
                    const [h, m] = serverTime.split(':').map(Number);
                    const currentMinutes = h * 60 + m;
                    if (currentMinutes > 450) { 
                        const late = currentMinutes - 450;
                        showToast(`Deteksi Keterlambatan: ${late} menit. Gunakan Margin Error jika diperlukan.`, "error", "Waktu Server");
                    } else {
                        showToast("Koordinat dan waktu sinkron.", "success", "GPS Aktif");
                    }
                } catch(e) { 
                    serverTime = new Date().toLocaleTimeString('id-ID', {hour12: false}); 
                }
                showLoading(false);
            }, (err) => { 
                showLoading(false); 
                let msg = "Gagal mengambil lokasi.";
                if (err.code === 1) msg = "Izin ditolak. Silakan aktifkan Lokasi di Pengaturan HP > Browser.";
                else if (err.code === 2) msg = "Lokasi tidak ditemukan. Pastikan GPS HP aktif dan Anda di luar ruangan.";
                else if (err.code === 3) msg = "Waktu habis (Timeout). Pastikan sinyal GPS kuat atau coba di area terbuka.";
                showToast(msg, "error", "GPS Gagal"); 
            }, geoOptions);
        }

        function setStatus(s, el) {
            // Urutan Logika: Harus Hadir/Margin sebelum Pulang
            if (s === 'Pulang' && !dailyStatus.hasHadir && !dailyStatus.hasMargin && selectedStatus !== 'Margin Error') {
                return showToast("Pulang ditolak. Anda wajib absen Hadir atau Margin Error terlebih dahulu hari ini.", "error", "Logika Urutan");
            }

            selectedStatus = s;
            document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active-hadir', 'active-pulang', 'active-special', 'active-error'));
            const cls = (s === 'Hadir') ? 'active-hadir' : (s === 'Pulang' ? 'active-pulang' : (s === 'Margin Error' ? 'active-error' : 'active-special'));
            el.classList.add(cls);
            
            document.getElementById('status-v').classList.remove('hidden');
            document.getElementById('duration-box').classList.toggle('hidden', !['Izin', 'Cuti', 'Sakit', 'Dinas'].includes(s));
            validateForm();
        }

        async function openCamera(mode) {
            activeCameraMode = mode;
            document.getElementById('camera-overlay').style.display = 'flex';
            const constraints = { video: { facingMode: (mode === 'kerja') ? 'environment' : 'user' } };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            document.getElementById('video-preview').srcObject = stream;
        }

        function closeCamera() {
            const v = document.getElementById('video-preview');
            if (v.srcObject) v.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('camera-overlay').style.display = 'none';
        }

        function takePicture() {
            const v = document.getElementById('video-preview'), c = document.createElement('canvas');
            const ctx = c.getContext('2d');
            c.width = 600; c.height = 900;
            
            const sW = v.videoWidth, sH = v.videoHeight;
            const targetRatio = 0.666;
            let dW, dH, dX, dY;
            if (sW / sH > targetRatio) { dH = sH; dW = sH * targetRatio; dX = (sW - dW) / 2; dY = 0; }
            else { dW = sW; dH = sW / targetRatio; dX = 0; dY = (sH - dH) / 2; }
            ctx.drawImage(v, dX, dY, dW, dH, 0, 0, 600, 900);
            
            // Professional Watermark
            ctx.fillStyle = "rgba(0, 0, 0, 0.65)";
            ctx.fillRect(0, 720, 600, 180);
            ctx.fillStyle = "white";
            ctx.font = "bold 28px Poppins"; ctx.fillText((currentUser ? currentUser.Nama : "REGISTRASI").toUpperCase(), 30, 770);
            ctx.font = "18px Poppins"; ctx.fillText((currentUser ? currentUser.Jabatan : "CALON PEGAWAI") + " | " + selectedStatus.toUpperCase(), 30, 805);
            ctx.font = "14px Poppins"; ctx.fillText("WIB: " + (serverTime || "MENCARI...") + " | KOOR: " + coordinates, 30, 840);
            ctx.fillStyle = "#10b981"; ctx.font = "bold 12px Poppins"; ctx.fillText("✓ UPT PSDA VERIFIED IMAGE SYSTEM", 30, 875);

            const data = c.toDataURL('image/jpeg', 0.8);
            if (activeCameraMode === 'profile') {
                profilePhotoRaw = data;
                document.getElementById('preview-profile').classList.remove('hidden');
                document.getElementById('preview-profile').querySelector('img').src = data;
                document.getElementById('placeholder-reg-photo').classList.add('hidden');
            } else if (activeCameraMode === 'selfie') {
                selfieRaw = data; document.getElementById('preview-selfie').classList.remove('hidden');
                document.getElementById('preview-selfie').querySelector('img').src = data;
                document.getElementById('retry-selfie').classList.remove('hidden');
                document.getElementById('photo-v').classList.remove('hidden');
            } else {
                kerjaRaw = data; document.getElementById('preview-kerja').classList.remove('hidden');
                document.getElementById('preview-kerja').querySelector('img').src = data;
                document.getElementById('retry-kerja').classList.remove('hidden');
            }
            closeCamera();
            validateForm();
        }

        function validateForm() {
            const notes = document.getElementById('attendance-notes').value;
            const hasNotes = notes.length >= 5;
            const hasMedia = (selfieRaw && kerjaRaw);
            document.getElementById('notes-v').classList.toggle('hidden', !hasNotes);
            document.getElementById('media-v').classList.toggle('hidden', !hasMedia);
            const btn = document.getElementById('final-submit');
            if (selectedStatus && hasNotes && hasMedia) {
                btn.classList.replace('opacity-50', 'opacity-100'); btn.classList.replace('pointer-events-none', 'pointer-events-auto');
            } else {
                btn.classList.replace('opacity-100', 'opacity-50'); btn.classList.add('pointer-events-none');
            }
        }

        function confirmSubmitFlow() {
            if (["Hadir", "Pulang"].includes(selectedStatus)) { submitAttendance(); return; }
            let msg = `Kirim status "${selectedStatus.toUpperCase()}" sekarang? `;
            switch(selectedStatus) {
                case 'Izin': msg += "Mohon lampirkan foto Surat Izin Anda."; break;
                case 'Sakit': msg += "Mohon lampirkan foto Surat Keterangan Dokter."; break;
                case 'Dinas': msg += "Mohon lampirkan foto Surat Perintah Dinas."; break;
                case 'Cuti': msg += "Mohon lampirkan foto Surat Izin Cuti resmi."; break;
                case 'Margin Error': msg += "Foto kondisi/hambatan dengan jelas & tulis keterangan lengkap."; break;
            }
            document.getElementById('modal-msg').innerText = msg;
            document.getElementById('confirm-submit-btn').onclick = () => { closeModal(); submitAttendance(); };
            document.getElementById('modal-confirm').style.display = 'flex';
        }

        async function submitAttendance() {
            showLoading(true, "Mengirim Data Presensi...");
            const payload = {
                action: "submitAttendance", nama: currentUser.Nama, jabatan: currentUser.Jabatan,
                status: selectedStatus, koordinat: coordinates, fotoSelfie: selfieRaw,
                fotoKerja: kerjaRaw, keterangan: document.getElementById('attendance-notes').value + (document.getElementById('duration-box').classList.contains('hidden') ? "" : " ["+document.getElementById('rentang-waktu').value+" Hari]")
            };
            try {
                const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
                const res = await response.json();
                if (res.status === "success") { showToast(res.message, "success", "Berhasil"); setTimeout(() => location.reload(), 4500); }
                else showToast(res.message, "error", "Gagal");
            } catch (e) { showToast("Gagal mengirim data ke server.", "error"); }
            showLoading(false);
        }

        // Utils
        function toggleManual(sel, id) { document.getElementById(id).classList.toggle('hidden', sel.value !== 'manual'); }
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = ev => {
                    profilePhotoRaw = ev.target.result;
                    document.getElementById('preview-profile').classList.remove('hidden');
                    document.getElementById('preview-profile').querySelector('img').src = ev.target.result;
                    document.getElementById('placeholder-reg-photo').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        async function handleRegister() {
            const j = document.getElementById('reg-jabatan').value, w = document.getElementById('reg-wilayah').value;
            const payload = {
                action: "register", ID: document.getElementById('reg-id').value, Nama: document.getElementById('reg-nama').value,
                Jabatan: j === 'manual' ? document.getElementById('manual-jabatan').value : j,
                Wilayah: w === 'manual' ? document.getElementById('manual-wilayah').value : w,
                Email: document.getElementById('reg-email').value, NomorHP: document.getElementById('reg-hp').value,
                LokasiPenempatan: document.getElementById('reg-lokasi').value, Password: document.getElementById('reg-password').value,
                FotoUrl: profilePhotoRaw
            };
            if (!payload.Nama || !profilePhotoRaw) return showToast("Foto profil & Nama wajib diisi.", "error");
            showLoading(true, "Mendaftarkan Pegawai...");
            try {
                const res = await (await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) })).json();
                if (res.status === "success") { showToast("Pendaftaran Berhasil!", "success", "Sistem"); setTimeout(() => navigateTo('login-screen'), 3000); }
                else showToast(res.message, "error");
            } catch (e) { showToast("Gagal terhubung ke server.", "error"); }
            showLoading(false);
        }

        async function handleForgotPassword() {
            const inp = document.getElementById('forgot-input').value;
            if(!inp) return showToast("Masukkan kontak terdaftar.", "error");
            showLoading(true, "Mengecek Database...");
            try {
                const res = await (await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "forgotPassword", input: inp }) })).json();
                showToast(res.message, "success", "Berhasil");
                setTimeout(() => navigateTo('login-screen'), 3000);
            } catch (e) { showToast("Permintaan gagal.", "error"); }
            showLoading(false);
        }
    </script>
</body>
</html>
