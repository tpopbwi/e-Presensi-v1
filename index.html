<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UPT PSDA - Pro Attendance System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseInit = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, getDoc };
    </script>

    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-highlight: rgba(255, 255, 255, 0.7);
            --emerald-pro: #10b981;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #cbd5e1;
            margin: 0; padding: 0;
            height: 100dvh;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        .bg-decoration {
            position: absolute; width: 500px; height: 500px; border-radius: 50%;
            filter: blur(120px); z-index: -1; animation: move 25s infinite alternate;
        }
        @keyframes move { from { transform: translate(-50%, -50%); } to { transform: translate(50%, 50%); } }

        .app-container {
            width: 100%; height: 100dvh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(40px) saturate(160%);
            -webkit-backdrop-filter: blur(40px) saturate(160%);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            border-left: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-border);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (min-width: 1024px) {
            .app-container { width: 420px; height: 880px; max-height: 95vh; border-radius: 40px; border: 2px solid var(--glass-border); box-shadow: 0 50px 100px rgba(0,0,0,0.25); }
        }

        .screen {
            position: absolute; inset: 0; 
            padding: 0.5rem; 
            display: flex; flex-direction: column;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease;
            will-change: transform, opacity; z-index: 1;
        }

        .pill-glass-3d {
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); border-radius: 22px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.15), inset 0 1px 1px var(--glass-highlight);
            transition: all 0.1s ease; position: relative; overflow: hidden;
        }
        .pill-glass-3d:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 3px 0 rgba(0,0,0,0.15); }
        .pill-glass-3d:disabled { opacity: 0.25; filter: grayscale(1); cursor: not-allowed; }

        .input-glass {
            background: rgba(255, 255, 255, 0.15); border: 1px solid var(--glass-border);
            border-radius: 18px; backdrop-filter: blur(10px); box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
            width: 100%; padding: 14px 20px; font-weight: 600; color: #1e293b; outline: none;
        }

        .screen-hidden { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .screen-prev { transform: translateX(-30%) scale(0.9); opacity: 0; pointer-events: none; }
        .screen-active { transform: translateX(0); opacity: 1; z-index: 10; }

        .locked-section { opacity: 0.3; pointer-events: none; filter: blur(4px); transition: all 0.5s ease; }
        .unlocked-section { opacity: 1; pointer-events: auto; filter: none; }

        #camera-overlay, #qr-scanner-overlay { position: absolute; inset: 0; background: black; z-index: 1000; display: none; flex-direction: column; }
        
        .toast-pro {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-150px);
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 15px 25px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); z-index: 10000;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: max-content; max-width: 90vw; border: 1px solid white;
        }
        .toast-pro.show { transform: translateX(-50%) translateY(0); }

        /* --- DARK SHADOWS (NO WHITE BG) --- */
        .photo-portrait-shadow {
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .icon-drop-shadow {
            filter: drop-shadow(0 20px 20px rgba(0, 0, 0, 0.6));
        }

        .active-hadir { background: #10b981 !important; color: white !important; box-shadow: 0 6px 0 #065f46 !important; }
        .active-pulang { background: #f59e0b !important; color: white !important; box-shadow: 0 6px 0 #92400e !important; }
        .active-error { background: #ef4444 !important; color: white !important; box-shadow: 0 6px 0 #991b1b !important; }
        .active-special { background: #3b82f6 !important; color: white !important; box-shadow: 0 6px 0 #1e40af !important; }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        #qr-reader { width: 100% !important; border: none !important; }
        #qr-reader video { border-radius: 30px; }
    </style>
</head>
<body>

    <div class="bg-decoration bg-blue-500" style="top: 0%; left: 0%;"></div>
    <div class="bg-decoration bg-emerald-400" style="bottom: 0%; right: 0%;"></div>

    <!-- TOAST -->
    <div id="toast-element" class="toast-pro">
        <div id="toast-icon-box" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">!</div>
        <div class="flex flex-col">
            <p id="toast-title" class="text-[10px] font-black uppercase text-slate-400 tracking-widest leading-none mb-1">Notifikasi</p>
            <p id="toast-text" class="text-xs font-bold text-slate-800 tracking-tight"></p>
        </div>
    </div>

    <!-- MODAL KONFIRMASI -->
    <div id="modal-confirm" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[9500] hidden items-center justify-center p-6">
        <div class="bg-white rounded-[35px] p-8 w-full max-w-sm shadow-2xl space-y-6 text-center">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto text-blue-600">
                <i class="fas fa-question-circle text-3xl"></i>
            </div>
            <h3 class="font-black text-xl text-slate-800 uppercase tracking-tighter leading-none">Konfirmasi</h3>
            <p id="modal-msg" class="text-sm text-slate-500 font-medium"></p>
            <div class="flex gap-3">
                <button onclick="window.closeModal()" class="flex-1 py-4 font-bold text-slate-400 uppercase text-xs">Batal</button>
                <button id="confirm-submit-btn" class="flex-1 pill-glass-3d bg-slate-900 text-white font-black uppercase text-xs">Ya, Kirim</button>
            </div>
        </div>
    </div>

    <!-- GLOBAL LOADER -->
    <div id="global-loader" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md hidden flex-col items-center justify-center z-[9000] text-white">
        <div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loader-text" class="font-bold tracking-widest text-[10px] uppercase">Sinkronisasi Server...</p>
    </div>

    <div class="app-container">
        
        <!-- CAMERA OVERLAY -->
        <div id="camera-overlay">
            <video id="video-preview" class="w-full h-full object-cover" autoplay playsinline></video>
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-72 h-96 border-2 border-emerald-500 rounded-3xl shadow-[0_0_0_1000px_rgba(0,0,0,0.7)] pointer-events-none"></div>
            <div class="absolute bottom-10 left-0 right-0 flex justify-around items-center px-10">
                <button onclick="window.closeCamera()" class="p-5 bg-white/20 rounded-full text-white backdrop-blur-md"><i class="fas fa-times text-xl"></i></button>
                <button onclick="window.takePicture()" class="w-20 h-20 bg-white rounded-full border-8 border-white/30 shadow-2xl active:scale-90 transition"></button>
                <div class="w-14"></div>
            </div>
        </div>

        <!-- QR SCANNER OVERLAY -->
        <div id="qr-scanner-overlay">
            <div class="flex-1 flex flex-col p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-white font-black uppercase tracking-widest text-xs">Scan QR Akses</h2>
                    <button onclick="window.stopQRScanner()" class="p-3 bg-white/10 rounded-full text-white"><i class="fas fa-times"></i></button>
                </div>
                <div class="bg-white/5 rounded-[40px] overflow-hidden p-4 border border-white/10 flex-1 flex items-center relative">
                    <div id="qr-reader" class="w-full"></div>
                </div>
                <div class="py-6 flex flex-col items-center gap-4">
                    <p class="text-white/40 text-[10px] uppercase font-bold tracking-[0.2em]">Arahkan ke QR atau pilih galeri</p>
                    <button onclick="document.getElementById('qr-file-input').click()" class="pill-glass-3d px-6 py-3 bg-white/20 text-white font-black text-[10px] uppercase tracking-widest">
                        <i class="fas fa-image mr-2"></i> PILIH DARI GALERI
                    </button>
                    <input type="file" id="qr-file-input" accept="image/*" class="hidden" onchange="window.scanQRFromFile(event)">
                </div>
            </div>
        </div>

        <!-- SCREEN: LOGIN -->
        <div id="login-screen" class="screen screen-active justify-center space-y-10">
            <div class="flex flex-col items-center">
                <!-- Icon No White Bg -->
                <div class="w-24 h-24 flex items-center justify-center mb-6 icon-drop-shadow">
                    <img src="https://lh3.googleusercontent.com/d/1ognTdYTF6KwNc5aCOFl8T6UyFMcjvsnQ" class="w-full h-full object-contain" alt="Logo">
                </div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tighter text-center uppercase leading-none">UPT PSDA<br><span class="text-emerald-600">BONDOYUDO</span></h1>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-[0.3em] mt-2 text-center">Professional Presence System v3.5</p>
            </div>
            
            <div class="space-y-4 px-4">
                <input id="login-username" type="text" placeholder="ID / Nomor HP / Chat ID" class="input-glass">
                <input id="login-password" type="password" placeholder="Password" class="input-glass">
                <div class="flex items-center gap-3 px-2">
                    <input type="checkbox" id="save-session" class="w-5 h-5 rounded border-white/30 bg-white/20 text-emerald-600 focus:ring-emerald-500">
                    <label for="save-session" class="text-[10px] font-black text-slate-600 uppercase tracking-widest">Ingat Sesi Saya</label>
                </div>
                <button id="login-btn-action" onclick="window.handleLogin()" class="w-full pill-glass-3d py-5 bg-slate-900 text-white font-black text-lg">
                  <i class="fab fa-800px text-white-600 text-xl"></i>MASUK</button>
                
                <div class="flex items-center gap-4 py-2 opacity-30">
                    <div class="flex-1 h-[1px] bg-slate-800"></div>
                    <span class="text-[9px] font-black uppercase">Atau</span>
                    <div class="flex-1 h-[1px] bg-slate-800"></div>
                </div>
                
                <button onclick="window.startQRScanner()" class="w-full pill-glass-3d py-4 flex items-center justify-center gap-3 font-extrabold text-slate-700 bg-white/50">
                    <i class="fas fa-qrcode text-emerald-600 text-xl"></i>
                    SCAN QR LOGIN
                </button>
            </div>
            
            <div class="flex justify-between items-end pb-4 px-6 pt-4">
                <button onclick="window.navigateTo('forgot-screen')" class="text-left"><p class="text-[9px] text-slate-500 uppercase font-black">Lupa Sandi?</p></button>
                <button onclick="window.navigateTo('register-screen')" class="text-right"><p class="text-emerald-700 font-bold text-xs leading-none uppercase">Daftar Akun</p></button>
            </div>
        </div>

        <!-- SCREEN: REGISTER (Separated Fields) -->
        <div id="register-screen" class="screen screen-hidden overflow-y-auto scrollbar-hide">
            <div class="flex items-center gap-4 mb-6" onclick="window.navigateTo('login-screen')">
                <div class="p-3 bg-slate-900 text-white rounded-2xl"><i class="fas fa-chevron-left"></i></div>
                <h2 class="text-xl font-black text-slate-800 tracking-tight uppercase">Registrasi</h2>
            </div>
            <div class="space-y-6 pb-12 px-2">
                <div class="flex flex-col items-center space-y-4">
                    <div class="w-32 h-48 rounded-[30px] relative photo-portrait-shadow overflow-hidden bg-slate-800/20 backdrop-blur-md">
                        <div id="preview-profile" class="absolute inset-0 hidden"><img class="w-full h-full object-cover"></div>
                        <div id="placeholder-reg-photo" class="absolute inset-0 flex items-center justify-center">
                            <i class="fas fa-user-circle text-5xl text-slate-400"></i>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="window.openCamera('profile')" class="pill-glass-3d px-4 py-2 bg-white/50 text-slate-700 flex items-center gap-2 text-[10px] font-black uppercase"><i class="fas fa-camera"></i> Foto</button>
                        <button onclick="document.getElementById('file-upload-profile').click()" class="pill-glass-3d px-4 py-2 bg-white/50 text-slate-700 flex items-center gap-2 text-[10px] font-black uppercase"><i class="fas fa-upload"></i> Upload</button>
                        <input type="file" id="file-upload-profile" class="hidden" accept="image/*" onchange="window.handleFileUpload(event)">
                    </div>
                </div>
                <div class="space-y-3">
                    <input id="reg-id" type="text" placeholder="ID Pegawai (P001...)" class="input-glass">
                    <input id="reg-nama" type="text" placeholder="Nama Lengkap" class="input-glass">
                    <select id="reg-di" class="input-glass" onchange="window.toggleManual(this, 'manual-di')">
                        <option value="" disabled selected>Pilih Daerah Irigasi (DI)</option>
                        <option value="DI BARU">DI BARU</option><option value="DI POROLINGGO">DI POROLINGGO</option><option value="manual">Lainnya...</option>
                    </select>
                    <input id="manual-di" type="text" placeholder="Ketik Nama DI" class="input-glass hidden border-emerald-400">
                    <select id="reg-jabatan" class="input-glass" onchange="window.toggleManual(this, 'manual-jabatan')">
                        <option value="" disabled selected>Pilih Jabatan</option>
                        <option value="PPA">PPA</option><option value="Pekarya">Pekarya</option><option value="Staf Pengamat">Staf Pengamat</option><option value="manual">Lainnya...</option>
                    </select>
                    <input id="manual-jabatan" type="text" placeholder="Ketik Jabatan" class="input-glass hidden border-emerald-400">
                    <select id="reg-wilayah" class="input-glass" onchange="window.toggleManual(this, 'manual-wilayah')">
                        <option value="" disabled selected>Pilih Wilayah</option>
                        <option value="Bangorejo">Bangorejo</option><option value="Cluring">Cluring</option><option value="Pesanggaran">Pesanggaran</option><option value="Porolinggo">Porolinggo</option><option value="manual">Lainnya...</option>
                    </select>
                    <input id="reg-email" type="email" placeholder="Email Aktif" class="input-glass">
                    <input id="reg-hp" type="tel" placeholder="Nomor HP Aktif" class="input-glass">
                    <input id="reg-chatid" type="text" placeholder="Chat ID Telegram (Bot)" class="input-glass">
                    <input id="reg-lokasi" type="text" placeholder="Lokasi Penempatan" class="input-glass">
                    <input id="reg-password" type="password" placeholder="Password Baru" class="input-glass">
                </div>
                <button onclick="window.handleRegister()" class="w-full pill-glass-3d py-5 bg-emerald-600 text-white font-black text-lg shadow-[0_6px_0_#064e3b]">DAFTAR SEKARANG</button>
            </div>
        </div>

        <!-- SCREEN: PRESENSI -->
        <div id="presensi-screen" class="screen screen-hidden overflow-y-auto scrollbar-hide !px-2">
            <div class="flex flex-col items-center pt-8 mb-6">
                <!-- Profile No Bg Shadow -->
                <div class="rounded-[35px] relative photo-portrait-shadow overflow-hidden bg-slate-800/30 backdrop-blur-md" style="width: 130px; height: 195px;">
                    <img id="user-photo" src="" class="w-full h-full object-cover">
                    <div id="photo-v" class="absolute bottom-3 right-3 w-8 h-8 bg-emerald-50 rounded-full border-2 border-white hidden items-center justify-center text-white font-black shadow-lg"><i class="fas fa-check"></i></div>
                </div>
                <div class="mt-6 text-center px-4">
                    <h2 id="user-name" class="text-2xl font-black text-slate-800 tracking-tighter leading-none mb-1 uppercase">...</h2>
                    <p id="user-job" class="text-[10px] font-bold text-emerald-600 tracking-[0.2em] uppercase">...</p>
                    <div class="mt-4 px-6 py-2.5 bg-white/50 rounded-full border border-white inline-flex items-center gap-2 shadow-sm">
                        <div id="gps-dot" class="w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse"></div>
                        <span id="gps-text" class="text-[10px] font-black uppercase tracking-widest">Kunci GPS Lokasi</span>
                        <i id="gps-v" class="fas fa-check-circle hidden text-emerald-600"></i>
                    </div>
                </div>
            </div>

            <div class="px-2 mb-4">
                <button id="lock-gps-btn" onclick="window.getRealLocation()" class="w-full pill-glass-3d py-5 bg-emerald-600 text-white font-black text-sm uppercase tracking-widest">
                    <i class="fas fa-location-crosshairs mr-2"></i> AMBIL KOORDINAT (STEP 1)
                </button>
            </div>

            <div id="attendance-form" class="locked-section space-y-8 bg-white/30 border-y border-white/40 py-10 px-4 shadow-2xl mb-8 w-full rounded-[50px]">
                <div class="space-y-4">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-3">Kategori Presensi</label>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="btn-hadir" onclick="window.setStatus('Hadir', this)" class="status-btn pill-glass-3d py-6 font-black text-sm uppercase">Hadir</button>
                        <button id="btn-pulang" onclick="window.setStatus('Pulang', this)" class="status-btn pill-glass-3d py-6 font-black text-sm uppercase">Pulang</button>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <button id="btn-izin" onclick="window.setStatus('Izin', this)" class="status-btn pill-glass-3d py-4 font-bold text-[9px] uppercase">Izin</button>
                        <button id="btn-cuti" onclick="window.setStatus('Cuti', this)" class="status-btn pill-glass-3d py-4 font-bold text-[9px] uppercase">Cuti</button>
                        <button id="btn-sakit" onclick="window.setStatus('Sakit', this)" class="status-btn pill-glass-3d py-4 font-bold text-[9px] uppercase">Sakit</button>
                        <button id="btn-dinas" onclick="window.setStatus('Dinas', this)" class="status-btn pill-glass-3d py-4 font-bold text-[9px] uppercase">Dinas</button>
                    </div>
                    <div class="w-full">
                         <button id="btn-margin" onclick="window.setStatus('Margin Error', this)" class="status-btn w-full pill-glass-3d py-4 font-bold text-red-600 uppercase tracking-tighter">Hambatan (Margin Error)</button>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-3">Keterangan Aktivitas</label>
                    <textarea id="attendance-notes" oninput="window.validateForm()" class="input-glass !h-36 resize-none focus:ring-4 focus:ring-emerald-100" placeholder="Rincian tugas atau alasan kendala..."></textarea>
                </div>

                <div class="space-y-4">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-3">Lampiran Media</label>
                    <div class="grid grid-cols-2 gap-5">
                        <div class="relative">
                            <button onclick="window.openCamera('selfie')" class="w-full pill-glass-3d aspect-square flex flex-col items-center justify-center gap-3 overflow-hidden">
                                <div id="preview-selfie" class="absolute inset-0 hidden"><img class="w-full h-full object-cover"></div>
                                <i class="fas fa-chalkboard-teacher text-3xl text-slate-300"></i>
                                <span class="text-[9px] font-black uppercase text-slate-400">Selfie</span>
                            </button>
                            <button id="retry-selfie" onclick="window.openCamera('selfie')" class="absolute -top-2 -right-2 bg-white text-red-500 p-2 rounded-full hidden shadow-lg border border-red-50"><i class="fas fa-redo"></i></button>
                        </div>
                        <div class="relative">
                            <button onclick="window.openCamera('kerja')" class="w-full pill-glass-3d aspect-square flex flex-col items-center justify-center gap-3 overflow-hidden">
                                <div id="preview-kerja" class="absolute inset-0 hidden"><img class="w-full h-full object-cover"></div>
                                <i class="fas fa-map-location-dot text-3xl text-slate-300"></i>
                                <span class="text-[9px] font-black uppercase text-slate-400">Lokasi</span>
                            </button>
                            <button id="retry-kerja" onclick="window.openCamera('kerja')" class="absolute -top-2 -right-2 bg-white text-red-500 p-2 rounded-full hidden shadow-lg border border-red-50"><i class="fas fa-redo"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-4 pb-12">
                <button id="final-submit" onclick="window.confirmSubmitFlow()" class="w-full pill-glass-3d !bg-slate-900 !text-white py-6 font-black text-xl tracking-[0.2em] shadow-2xl opacity-50 pointer-events-none uppercase">Kirim Presensi</button>
            </div>
        </div>

        <!-- SCREEN: FORGOT -->
        <div id="forgot-screen" class="screen screen-hidden">
            <div class="flex items-center gap-4 mb-10" onclick="window.navigateTo('login-screen')">
                <div class="p-3 bg-slate-900 text-white rounded-2xl"><i class="fas fa-chevron-left"></i></div>
                <h2 class="text-xl font-black text-slate-800">Reset Password</h2>
            </div>
            <div class="flex-1 flex flex-col justify-center space-y-6">
                <div class="text-center space-y-2">
                    <div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                        <i class="fas fa-key text-amber-600 text-3xl"></i>
                    </div>
                    <p class="text-sm text-slate-600">Detail login akan dikirim ke Telegram & Email terdaftar.</p>
                </div>
                <input id="forgot-input" type="text" placeholder="Email / Nomor HP / Chat ID" class="input-glass">
                <button onclick="window.handleForgotPassword()" class="w-full pill-glass-3d py-5 bg-amber-600 text-white font-black text-lg shadow-[0_6px_0_#92400e]">KIRIM PERMINTAAN</button>
            </div>
        </div>
    </div>

    <script type="module">
        const API_URL = "https://script.google.com/macros/s/AKfycbzE8Ko__c6BgxbYIfz0Uvres49hsZ3yo_3JJ0eu6BbQVckKCqeL4Dhyu8bLSZsoZJ3qlw/exec";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'upt-psda-pro';
        
        let firebaseConfig;
        try { firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" }; }
        catch(e) { firebaseConfig = { apiKey: "" }; }

        let db, auth, user, html5QrCode = null;
        let currentUser = null, currentScreen = 'login-screen', selectedStatus = "", coordinates = "", selfieRaw = null, kerjaRaw = null, activeCameraMode = null, profilePhotoRaw = null;
        let serverTime = null, dailyStatus = { hasHadir: false, hasPulang: false, hasSpecial: false, hasMargin: false };

        const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, getDoc } = window.firebaseInit;

        // --- SESSION MANAGEMENT (LocalStorage Only) ---
        function loadSession() {
            const savedUser = localStorage.getItem('presensi_remember_user');
            const savedPass = localStorage.getItem('presensi_remember_pass');
            if(savedUser && savedPass) {
                document.getElementById('login-username').value = savedUser;
                document.getElementById('login-password').value = savedPass;
                document.getElementById('save-session').checked = true;
            }
        }

        if (firebaseConfig.apiKey) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            onAuthStateChanged(auth, async (u) => {
                user = u;
                loadSession();
                if (!user) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                }
            });
        }

        window.showToast = (msg, type = "info", title = "Pemberitahuan") => {
            const toast = document.getElementById('toast-element');
            const box = document.getElementById('toast-icon-box');
            document.getElementById('toast-text').innerText = msg;
            document.getElementById('toast-title').innerText = title;
            box.className = "w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg " + (type === "success" ? "bg-emerald-500 shadow-[0_0_20px_rgba(16,185,129,0.5)]" : "bg-red-500 shadow-[0_0_20px_rgba(239,68,68,0.5)]");
            box.innerHTML = type === "success" ? '<i class="fas fa-check"></i>' : '<i class="fas fa-exclamation"></i>';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4500);
        };

        window.showLoading = (s, text = "Sinkronisasi Server...") => { 
            const loader = document.getElementById('global-loader');
            const lText = document.getElementById('loader-text');
            if (lText) lText.innerText = text;
            loader.style.display = s ? 'flex' : 'none'; 
        };

        window.navigateTo = (id) => {
            const cur = document.getElementById(currentScreen), next = document.getElementById(id);
            if (!next) return;
            cur.classList.remove('screen-active'); cur.classList.add('screen-prev');
            next.classList.remove('screen-hidden', 'screen-prev'); next.classList.add('screen-active');
            currentScreen = id;
        };

        window.closeModal = () => { document.getElementById('modal-confirm').style.display = 'none'; };

        // --- QR SCANNER (Camera + File Upload) ---
        window.startQRScanner = () => {
            document.getElementById('qr-scanner-overlay').style.display = 'flex';
            html5QrCode = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, async (token) => {
                handleQRScanResult(token);
            }, (err) => {});
        };

        window.scanQRFromFile = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const tempScanner = new Html5Qrcode("qr-reader");
            tempScanner.scanFile(file, true)
                .then(token => handleQRScanResult(token))
                .catch(err => window.showToast("QR tidak ditemukan dalam gambar.", "error"));
        };

        async function handleQRScanResult(token) {
            window.stopQRScanner();
            window.showLoading(true, "Memvalidasi QR...");
            try {
                const res = await (await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "login", type: "qr", token }) })).json();
                if (res.status === "success") handleLoginSuccess(res.data);
                else window.showToast(res.message, "error");
            } catch (e) { window.showToast("Gagal terhubung.", "error"); }
            window.showLoading(false);
        }

        window.stopQRScanner = () => {
            if (html5QrCode) html5QrCode.stop().then(() => { document.getElementById('qr-scanner-overlay').style.display = 'none'; html5QrCode = null; });
            else document.getElementById('qr-scanner-overlay').style.display = 'none';
        };

        // --- AUTH ---
        window.handleLogin = async () => {
            const userInp = document.getElementById('login-username').value;
            const passInp = document.getElementById('login-password').value;
            const saveCheck = document.getElementById('save-session').checked;
            if (!userInp || !passInp) return window.showToast("Isi form lengkap.", "error");
            
            if(saveCheck) {
                localStorage.setItem('presensi_remember_user', userInp);
                localStorage.setItem('presensi_remember_pass', passInp);
            } else {
                localStorage.removeItem('presensi_remember_user');
                localStorage.removeItem('presensi_remember_pass');
            }

            window.showLoading(true, "Verifikasi Akun...");
            try {
                const res = await (await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "login", username: userInp, password: passInp }) })).json();
                if (res.status === "success") handleLoginSuccess(res.data);
                else window.showToast(res.message, "error");
            } catch (e) { window.showToast("Server tidak merespon.", "error"); }
            window.showLoading(false);
        };

        async function handleLoginSuccess(data) {
            currentUser = data;
            document.getElementById('user-name').innerText = currentUser.Nama;
            document.getElementById('user-job').innerText = currentUser.Jabatan;
            document.getElementById('user-photo').src = currentUser.FotoUrl;
            
            window.showLoading(true, "Cek Status Harian...");
            try {
                const sRes = await (await fetch(API_URL + "?action=getTodayStatus&nama=" + encodeURIComponent(currentUser.Nama))).json();
                dailyStatus = sRes;
                applyBusinessRules();
                window.navigateTo('presensi-screen');
                window.showToast("Selamat Datang!", "success");
            } catch (e) { window.showToast("Gagal cek status harian.", "error"); }
            window.showLoading(false);
        }

        // --- BUSINESS LOGIC (URUTAN SISTEM) ---
        function applyBusinessRules() {
            const btns = document.querySelectorAll('.status-btn');
            btns.forEach(b => b.disabled = false);

            if (dailyStatus.hasSpecial) {
                btns.forEach(b => b.disabled = true);
                window.showToast("Sudah ada laporan absen hari ini.", "error"); 
                return;
            }

            if (dailyStatus.hasPulang) {
                btns.forEach(b => b.disabled = true);
                window.showToast("Absensi hari ini sudah selesai.", "success");
                return;
            }

            if (!dailyStatus.hasHadir) document.getElementById('btn-pulang').disabled = true;

            if (dailyStatus.hasHadir) {
                document.getElementById('btn-hadir').disabled = true;
                document.getElementById('btn-margin').disabled = true;
                document.getElementById('btn-pulang').disabled = false;
            }

            if (dailyStatus.hasMargin && !dailyStatus.hasHadir) {
                document.getElementById('btn-margin').disabled = true;
                document.getElementById('btn-pulang').disabled = true; 
                document.getElementById('btn-hadir').disabled = false;
                window.showToast("Hambatan diterima. Silakan absen HADIR saat tiba.", "info");
            }
        }

        // --- GPS & CAMERA ---
        window.getRealLocation = () => {
            if (!navigator.geolocation) return window.showToast("GPS tidak didukung.", "error");
            window.showLoading(true, "Melacak GPS...");
            navigator.geolocation.getCurrentPosition(async (p) => {
                coordinates = `${p.coords.latitude}, ${p.coords.longitude}`;
                document.getElementById('gps-text').innerText = "GPS TERKUNCI";
                document.getElementById('gps-dot').className = "w-2.5 h-2.5 bg-emerald-500 rounded-full shadow-[0_0_10px_#10b981]";
                document.getElementById('gps-v').classList.remove('hidden');
                document.getElementById('lock-gps-btn').style.display = "none";
                document.getElementById('attendance-form').className = "unlocked-section space-y-8 bg-white/20 border-y border-white/40 py-10 px-4 shadow-2xl mb-8 w-full rounded-[55px]";
                
                try {
                    const t = await (await fetch(API_URL + "?action=getServerTime")).json();
                    serverTime = t.formattedTime;
                    const [h, m] = serverTime.split(':').map(Number);
                    if (h * 60 + m > 450) { // 07:30
                        window.showToast(`Peringatan: Terlambat ${h * 60 + m - 450} menit.`, "error", "Jam Server");
                    }
                } catch(e) { serverTime = new Date().toLocaleTimeString('id-ID', {hour12: false}); }
                window.showLoading(false);
            }, () => { window.showLoading(false); window.showToast("Gagal lokasi. Aktifkan GPS.", "error"); }, { enableHighAccuracy: true, timeout: 35000 });
        };

        window.setStatus = (s, el) => {
            selectedStatus = s;
            document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active-hadir', 'active-pulang', 'active-error', 'active-special'));
            let cls = 'active-special';
            if(s === 'Hadir') cls = 'active-hadir';
            if(s === 'Pulang') cls = 'active-pulang';
            if(s === 'Margin Error') cls = 'active-error';
            el.classList.add(cls);
            window.validateForm();
        };

        window.openCamera = async (mode) => {
            activeCameraMode = mode;
            document.getElementById('camera-overlay').style.display = 'flex';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode === 'kerja' ? 'environment' : 'user' } });
                document.getElementById('video-preview').srcObject = stream;
            } catch(e) { window.showToast("Izin kamera ditolak.", "error"); window.closeCamera(); }
        };

        window.closeCamera = () => {
            const v = document.getElementById('video-preview');
            if (v.srcObject) v.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('camera-overlay').style.display = 'none';
        };

        window.takePicture = () => {
            const v = document.getElementById('video-preview'), c = document.createElement('canvas'), ctx = c.getContext('2d');
            const targetW = 800, targetH = 1200; 
            c.width = targetW; c.height = targetH;
            const sW = v.videoWidth, sH = v.videoHeight, targetRatio = targetW / targetH;
            let dW, dH, dX, dY;
            if (sW / sH > targetRatio) { dH = sH; dW = sH * targetRatio; dX = (sW - dW) / 2; dY = 0; }
            else { dW = sW; dH = sW / targetRatio; dX = 0; dY = (sH - dH) / 2; }
            ctx.drawImage(v, dX, dY, dW, dH, 0, 0, targetW, targetH);
            
            // --- DESIGN WATERMARK PRO ---
            const grad = ctx.createLinearGradient(0, targetH * 0.65, 0, targetH);
            grad.addColorStop(0, "rgba(0, 0, 0, 0)"); grad.addColorStop(1, "rgba(0, 0, 0, 0.9)");
            ctx.fillStyle = grad; ctx.fillRect(0, targetH * 0.6, targetW, targetH * 0.4);
            ctx.fillStyle = "#10b981"; ctx.fillRect(40, targetH - 240, 6, 160);
            ctx.fillStyle = "#FFFFFF"; ctx.font = "800 42px Poppins";
            ctx.fillText((currentUser ? currentUser.Nama : "PROFIL").toUpperCase(), 65, targetH - 195);
            ctx.font = "600 26px Poppins"; ctx.fillStyle = "#E2E8F0";
            ctx.fillText((currentUser ? currentUser.Jabatan : "CALON") + " | " + selectedStatus.toUpperCase(), 65, targetH - 150);
            ctx.font = "400 20px Poppins"; ctx.fillStyle = "#CBD5E1";
            ctx.fillText("WAKTU: " + (serverTime || "--:--") + " WIB", 65, targetH - 110);
            ctx.fillText("COORD: " + (coordinates || "GPS UNLOCKED"), 65, targetH - 80);

            const badgeText = "âœ“ UPT PSDA BONDOYUDO VERIFIED";
            ctx.font = "bold 14px Poppins";
            const bWidth = ctx.measureText(badgeText).width + 30;
            ctx.fillStyle = "rgba(16, 185, 129, 0.2)";
            roundRect(ctx, 60, targetH - 55, bWidth, 32, 16, true);
            ctx.fillStyle = "#10b981"; ctx.fillText(badgeText, 75, targetH - 33);

            const data = c.toDataURL('image/jpeg', 0.85);
            if (activeCameraMode === 'profile') {
                profilePhotoRaw = data; document.getElementById('preview-profile').classList.remove('hidden');
                document.getElementById('preview-profile').querySelector('img').src = data;
                document.getElementById('placeholder-reg-photo').classList.add('hidden');
            } else if (activeCameraMode === 'selfie') {
                selfieRaw = data; document.getElementById('preview-selfie').classList.remove('hidden');
                document.getElementById('preview-selfie').querySelector('img').src = data;
                document.getElementById('retry-selfie').classList.remove('hidden');
                document.getElementById('photo-v').classList.remove('hidden');
            } else {
                kerjaRaw = data; document.getElementById('preview-kerja').classList.remove('hidden');
                document.getElementById('preview-kerja').querySelector('img').src = data;
                document.getElementById('retry-kerja').classList.remove('hidden');
            }
            window.closeCamera(); window.validateForm();
        };

        function roundRect(ctx, x, y, width, height, radius, fill) {
            ctx.beginPath(); ctx.moveTo(x + radius, y); ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius); ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height); ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius); ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y); ctx.closePath();
            if (fill) ctx.fill();
        }

        window.validateForm = () => {
            const hasNotes = document.getElementById('attendance-notes').value.length >= 5;
            const hasMedia = (selfieRaw && kerjaRaw);
            const btn = document.getElementById('final-submit');
            if (selectedStatus && hasNotes && hasMedia) {
                btn.classList.replace('opacity-50', 'opacity-100'); btn.classList.replace('pointer-events-none', 'pointer-events-auto');
            } else { btn.classList.replace('opacity-100', 'opacity-50'); btn.classList.add('pointer-events-none'); }
        };

        window.confirmSubmitFlow = () => {
            let msg = `Kirim data ${selectedStatus.toUpperCase()} ke server?`;
            if (selectedStatus === 'Margin Error') msg = "PENTING: Laporan hambatan diproses. INGAT: Anda TETAP WAJIB absen HADIR saat tiba di lokasi.";
            document.getElementById('modal-msg').innerText = msg;
            document.getElementById('confirm-submit-btn').onclick = () => { window.closeModal(); window.submitAttendance(); };
            document.getElementById('modal-confirm').style.display = 'flex';
        };

        window.submitAttendance = async () => {
            window.showLoading(true, "Mengirim Presensi...");
            const [h, m] = serverTime.split(':').map(Number);
            let calculatedScore = (selectedStatus === 'Hadir' && (h * 60 + m > 450)) ? 40 : 50;
            if (selectedStatus === 'Margin Error') calculatedScore = 10;
            if (['Izin','Cuti','Sakit','Dinas'].includes(selectedStatus)) calculatedScore = 0;

            const body = { action: "submitAttendance", nama: currentUser.Nama, jabatan: currentUser.Jabatan, status: selectedStatus, koordinat: coordinates, fotoSelfie: selfieRaw, fotoKerja: kerjaRaw, keterangan: document.getElementById('attendance-notes').value, skor: calculatedScore };
            try {
                const res = await (await fetch(API_URL, { method: "POST", body: JSON.stringify(body) })).json();
                if (res.status === "success") { window.showToast(res.message, "success"); setTimeout(() => location.reload(), 4500); }
                else window.showToast(res.message, "error");
            } catch (e) { window.showToast("Gagal kirim.", "error"); }
            window.showLoading(false);
        };

        window.toggleManual = (sel, id) => document.getElementById(id).classList.toggle('hidden', sel.value !== 'manual');
        
        window.handleFileUpload = (e) => {
            const reader = new FileReader();
            reader.onload = ev => {
                profilePhotoRaw = ev.target.result; document.getElementById('preview-profile').classList.remove('hidden');
                document.getElementById('preview-profile').querySelector('img').src = ev.target.result;
                document.getElementById('placeholder-reg-photo').classList.add('hidden');
            }; reader.readAsDataURL(e.target.files[0]);
        };

        window.handleRegister = async () => {
            const d = document.getElementById('reg-di').value, j = document.getElementById('reg-jabatan').value, w = document.getElementById('reg-wilayah').value;
            const body = { action: "register", ID: document.getElementById('reg-id').value, Nama: document.getElementById('reg-nama').value, DI: d === 'manual' ? document.getElementById('manual-di').value : d, Jabatan: j === 'manual' ? document.getElementById('manual-jabatan').value : j, Wilayah: w, Email: document.getElementById('reg-email').value, NomorHP: document.getElementById('reg-hp').value, ChatID: document.getElementById('reg-chatid').value, LokasiPenempatan: document.getElementById('reg-lokasi').value, Password: document.getElementById('reg-password').value, FotoUrl: profilePhotoRaw };
            if (!body.Nama || !profilePhotoRaw || !body.DI || !body.ChatID) return window.showToast("Data wajib belum lengkap.", "error");
            window.showLoading(true, "Mendaftar...");
            try {
                const res = await (await fetch(API_URL, { method: "POST", body: JSON.stringify(body) })).json();
                if (res.status === "success") { window.navigateTo('login-screen'); window.showToast("Pendaftaran Berhasil!", "success"); } 
                else window.showToast(res.message, "error");
            } catch (e) { window.showToast("Gagal mendaftar.", "error"); }
            window.showLoading(false);
        };

        window.handleForgotPassword = async () => {
            const inp = document.getElementById('forgot-input').value;
            if (!inp) return window.showToast("Isi data kontak.", "error");
            window.showLoading(true, "Mengecek...");
            try {
                const res = await (await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "forgotPassword", input: inp }) })).json();
                window.showToast(res.message, res.status === "success" ? "success" : "error");
            } catch (e) { window.showToast("Gagal koneksi.", "error"); }
            window.showLoading(false);
        };
    </script>
</body>
</html>



